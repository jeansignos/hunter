<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIR4 Market Hunter - Pro</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3524/3524659.png">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ============ NOVO LAYOUT COMPACTO ============ */
        .filtros-topo {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px;
            background: #1a202c;
            border-radius: 10px;
            margin-bottom: 15px;
            align-items: flex-start;
            justify-content: center;
        }
        
        /* Mini Dropdowns inline */
        .mini-dropdown {
            position: relative;
            min-width: 140px;
        }
        
        .mini-dropdown-btn {
            width: 100%;
            padding: 8px 12px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .mini-dropdown-btn:hover {
            border-color: #667eea;
            background: #3d4a5c;
        }
        
        .mini-dropdown-btn.active {
            border-color: #48bb78;
            background: #2d4a3d;
        }
        
        .mini-dropdown-count {
            background: #4a5568;
            color: #a0aec0;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }
        
        .mini-dropdown-count.has-value {
            background: #48bb78;
            color: white;
        }
        
        .mini-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 280px;
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 12px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
        }
        
        .mini-dropdown-content.show {
            display: block;
        }
        
        .mini-dropdown-content .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .mini-dropdown-content .input-row label {
            flex: 1;
            font-size: 0.8rem;
            color: #a0aec0;
        }
        
        .mini-dropdown-content .input-row input {
            width: 70px;
            padding: 5px 8px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 4px;
            color: white;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .mini-dropdown-content .btn-aplicar {
            width: 100%;
            padding: 8px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
        }
        
        .mini-dropdown-content .btn-aplicar:hover {
            background: #3182ce;
        }
        
        /* Linha de filtros principais */
        .filtros-linha-principal {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        /* Select compacto */
        .select-compacto {
            padding: 8px 12px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.8rem;
            cursor: pointer;
            min-width: 130px;
        }
        
        .select-compacto:hover {
            border-color: #667eea;
        }
        
        /* Input compacto */
        .input-compacto {
            padding: 8px 12px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.8rem;
            width: 100px;
        }
        
        .input-compacto::placeholder {
            color: #718096;
        }
        
        /* Grupo com label */
        .filtro-grupo-inline {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .filtro-grupo-inline label {
            font-size: 0.65rem;
            color: #718096;
            text-transform: uppercase;
        }
        
        /* Bot칫es de a칞칚o compactos */
        .btn-acao-compacto {
            padding: 8px 15px;
            background: #4a5568;
            color: #e2e8f0;
            border: 1px solid #4a5568;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }
        
        .btn-acao-compacto:hover {
            background: #5a6a7c;
            border-color: #667eea;
        }
        
        .btn-buscar-principal {
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }
        
        .btn-buscar-principal:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-1px);
        }
        
        /* Contador de resultados */
        .contador-resultados {
            text-align: center;
            padding: 10px;
            background: #1a202c;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .contador-resultados .numero {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4299e1;
        }
        
        .contador-resultados .texto {
            font-size: 0.75rem;
            color: #718096;
        }
        
        /* Tabs Listado/Com Lance */
        .tabs-status {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .tab-status {
            padding: 10px 30px;
            background: #2d3748;
            color: #a0aec0;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .tab-status:first-child {
            border-radius: 6px 0 0 6px;
        }
        
        .tab-status:last-child {
            border-radius: 0 6px 6px 0;
        }
        
        .tab-status.active {
            background: #4299e1;
            color: white;
        }
        
        .tab-status:hover:not(.active) {
            background: #3d4a5c;
        }
        
        /* Campo de busca por nome */
        .busca-nome {
            width: 200px;
            padding: 8px 12px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.8rem;
        }
        
        .busca-nome::placeholder {
            color: #718096;
        }
        
        /* Grid de Esp칤ritos */
        .espiritos-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        
        .espirito-item {
            width: 55px;
            height: 55px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            background: #2d3748;
        }
        
        .espirito-item:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }
        
        .espirito-item.selected {
            border-color: #48bb78;
            box-shadow: 0 0 10px rgba(72, 187, 120, 0.5);
        }
        
        .espirito-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Badge Bidding */
        .badge-bidding {
            position: absolute;
            top: -5px;
            left: -5px;
            background: #ed8936;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: bold;
            transform: rotate(-15deg);
            z-index: 10;
        }
        
        .tempo-restante {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: #f6e05e;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        /* ============ ESTILOS ANTERIORES ============ */
        .carregar-mais-btn {
            width: 100%;
            padding: 10px 15px;
            margin-top: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .carregar-mais-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .carregar-mais-btn:disabled {
            background: #4a5568;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .carregar-mais-btn i {
            font-size: 0.9rem;
        }
        
        /* Estilos Premium */
        .premium-badge {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
            color: #1a202c;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .premium-filter {
            position: relative;
        }
        
        .premium-filter.locked::after {
            content: "游 Premium";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #f6ad55;
            font-size: 0.8rem;
            border-radius: 5px;
            cursor: not-allowed;
        }
        
        .premium-filter.locked input,
        .premium-filter.locked select {
            pointer-events: none;
            opacity: 0.5;
        }
        
        .user-nav {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #2d3748;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .user-nav a {
            color: #a0aec0;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .user-nav a:hover {
            background: #4a5568;
            color: white;
        }
        
        /* Dropdown colaps치vel de Filtros */
        .dropdown-filtro {
            margin-bottom: 10px;
        }
        
        .dropdown-btn {
            width: 100%;
            padding: 10px 12px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        
        .dropdown-btn:hover {
            background: #3d4a5c;
            border-color: #667eea;
        }
        
        .dropdown-btn span:first-child {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dropdown-count {
            color: #a0aec0;
            font-size: 0.75rem;
            margin-left: auto;
            margin-right: 10px;
        }
        
        .dropdown-arrow {
            transition: transform 0.3s ease;
        }
        
        .dropdown-filtro.open .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .dropdown-content {
            padding: 15px;
            background: #1a202c;
            border: 1px solid #4a5568;
            border-top: none;
            border-radius: 0 0 8px 8px;
            margin-top: -5px;
        }
        
        .btn-aplicar-dropdown {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .btn-aplicar-dropdown:hover {
            background: #3182ce;
        }
        
        /* Bot칫es secund치rios menores */
        .botoes-filtro-grupo {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .btn-filtro-secundario {
            flex: 1;
            padding: 8px 10px;
            background: #4a5568;
            color: #e2e8f0;
            border: 1px solid #4a5568;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-filtro-secundario:hover {
            background: #5a6a7c;
            border-color: #667eea;
        }
        
        .btn-filtro-secundario i {
            font-size: 0.7rem;
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .user-status .premium-user {
            color: #f6ad55;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container layout-horizontal">
        
        <!-- Barra de usu치rio -->
        <div class="user-nav">
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('auth.profile') }}"><i class="fas fa-user"></i> {{ current_user.username }}</a>
                {% if current_user.is_admin %}
                    <a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-cog"></i> Admin</a>
                {% endif %}
                <div class="user-status">
                    {% if is_premium %}
                        <span class="premium-user"><i class="fas fa-crown"></i> Premium</span>
                    {% else %}
                        <span style="color: #a0aec0;">Conta Gratuita</span>
                    {% endif %}
                    <a href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt"></i> Sair</a>
                </div>
            {% else %}
                <a href="{{ url_for('auth.login') }}"><i class="fas fa-sign-in-alt"></i> Login</a>
                <a href="{{ url_for('auth.register') }}"><i class="fas fa-user-plus"></i> Cadastrar</a>
                <div class="user-status">
                    <span style="color: #a0aec0;">Visitante</span>
                </div>
            {% endif %}
        </div>
        
        <!-- ============ NOVO LAYOUT COMPACTO ============ -->
        <div class="filtros-topo">
            <!-- Linha 1: Filtros principais -->
            <div class="filtros-linha-principal" style="width: 100%; flex-wrap: wrap;">
                
                <!-- Classe -->
                <div class="filtro-grupo-inline">
                    <label>Classe</label>
                    <select id="classe" name="classe" class="select-compacto">
                        <option value="0">Todas</option>
                        {% for id, info in classes.items() %}
                        <option value="{{ id }}">{{ info.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Servidor -->
                <div class="filtro-grupo-inline">
                    <label>Regi칚o</label>
                    <select id="regiao" name="regiao" class="select-compacto" onchange="atualizarServidores()">
                        <option value="">Todas</option>
                        <option value="ASIA1">ASIA1</option>
                        <option value="ASIA2">ASIA2</option>
                        <option value="ASIA3">ASIA3</option>
                        <option value="ASIA4">ASIA4</option>
                        <option value="INMENA1">INMENA1</option>
                        <option value="EU1">EU1</option>
                        <option value="SA1">SA1</option>
                        <option value="SA2">SA2</option>
                        <option value="NA1">NA1</option>
                        <option value="NA2">NA2</option>
                    </select>
                </div>
                
                <div class="filtro-grupo-inline">
                    <label>Servidor</label>
                    <select id="servidor" name="servidor" class="select-compacto">
                        <option value="">Todos</option>
                    </select>
                </div>
                
                <!-- Level e Poder -->
                <div class="filtro-grupo-inline">
                    <label>Level M칤n.</label>
                    <input type="number" id="level_min" class="input-compacto" placeholder="0">
                </div>
                
                <div class="filtro-grupo-inline">
                    <label>Poder M칤n.</label>
                    <input type="number" id="power_min" class="input-compacto" placeholder="0">
                </div>
                
                <!-- Pre칞o -->
                <div class="filtro-grupo-inline">
                    <label>Pre칞o M칤n.</label>
                    <input type="number" id="price_min" class="input-compacto" placeholder="0">
                </div>
                
                <div class="filtro-grupo-inline">
                    <label>Pre칞o M치x.</label>
                    <input type="number" id="price_max" class="input-compacto" placeholder="10000">
                </div>
                
                <!-- Ordena칞칚o -->
                <div class="filtro-grupo-inline">
                    <label>Ordenar por</label>
                    <select id="ordenacao" class="select-compacto" onchange="mudarOrdenacao()">
                        <option value="power">Maior Poder</option>
                        <option value="level">Maior Level</option>
                        <option value="critico">Maior Cr칤tico</option>
                        <option value="evasao">Maior Evas칚o</option>
                        <option value="derrubada">Maior Derrubada</option>
                        <option value="evasao_critico">Maior Evas칚o Cr칤tico</option>
                        <option value="ataque_fisico">Maior ATK F칤sico</option>
                        <option value="ataque_magico">Maior ATK M치gico</option>
                        <option value="price">Menor Pre칞o</option>
                        <option value="price_desc">Maior Pre칞o</option>
                        <option value="aceleramento">Maior Minera칞칚o</option>
                        <option value="aconegro">Mais A칞o Negro</option>
                        <option value="codex">Maior Codex</option>
                        <option value="mina">Maior N칤vel Mina</option>
                    </select>
                </div>
            </div>
            
            <!-- Linha 2: Dropdowns de filtros avan칞ados -->
            <div class="filtros-linha-principal" style="width: 100%; margin-top: 10px; justify-content: center;">
                
                <!-- Dropdown Minera칞칚o -->
                <div class="mini-dropdown">
                    <button type="button" class="mini-dropdown-btn" onclick="toggleMiniDropdown('dd-mineracao')">
                        <span><i class="fas fa-gem"></i> Minera칞칚o</span>
                        <span class="mini-dropdown-count" id="count-mineracao">0</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="dd-mineracao" class="mini-dropdown-content">
                        <div class="input-row">
                            <label>Mina (N칤vel)</label>
                            <input type="number" id="mina_min" placeholder="0" onchange="atualizarCountMineracao()">
                        </div>
                        <div class="input-row">
                            <label style="color: #f6e05e;">Boost Minera칞칚o (%)</label>
                            <input type="number" id="status_aceleramento" placeholder="0" onchange="atualizarCountMineracao()">
                        </div>
                        <div class="input-row">
                            <label style="color: #f6e05e;">Ganho A칞o Negro (%)</label>
                            <input type="number" id="status_aconegro" placeholder="0" onchange="atualizarCountMineracao()">
                        </div>
                        <button type="button" class="btn-aplicar" onclick="toggleMiniDropdown('dd-mineracao')">Aplicar</button>
                    </div>
                </div>
                
                <!-- Dropdown Training/Treino -->
                <div class="mini-dropdown">
                    <button type="button" class="mini-dropdown-btn" onclick="toggleMiniDropdown('dd-treino')">
                        <span><i class="fas fa-dumbbell"></i> Treino</span>
                        <span class="mini-dropdown-count" id="count-treino">0</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="dd-treino" class="mini-dropdown-content">
                        <div class="input-row">
                            <label>Constitui칞칚o</label>
                            <input type="number" id="treino_constituicao" placeholder="0" min="0" max="23" onchange="atualizarCountTreino()">
                            <span style="color:#718096;font-size:0.7rem;">/23</span>
                        </div>
                        <div class="input-row">
                            <label>M칰sculo</label>
                            <input type="number" id="treino_muscular" placeholder="0" min="0" max="23" onchange="atualizarCountTreino()">
                            <span style="color:#718096;font-size:0.7rem;">/23</span>
                        </div>
                        <div class="input-row">
                            <label>Nine Yin</label>
                            <input type="number" id="treino_noveyin" placeholder="0" min="0" max="23" onchange="atualizarCountTreino()">
                            <span style="color:#718096;font-size:0.7rem;">/23</span>
                        </div>
                        <div class="input-row">
                            <label>Nine Yang</label>
                            <input type="number" id="treino_noveyang" placeholder="0" min="0" max="23" onchange="atualizarCountTreino()">
                            <span style="color:#718096;font-size:0.7rem;">/23</span>
                        </div>
                        <div class="input-row">
                            <label>Postura Sapo</label>
                            <input type="number" id="treino_sapo" placeholder="0" min="0" max="23" onchange="atualizarCountTreino()">
                            <span style="color:#718096;font-size:0.7rem;">/23</span>
                        </div>
                        <button type="button" class="btn-aplicar" onclick="toggleMiniDropdown('dd-treino')">Aplicar</button>
                    </div>
                </div>
                
                <!-- Dropdown N칤vel (Codex/Potencial) -->
                <div class="mini-dropdown">
                    <button type="button" class="mini-dropdown-btn" onclick="toggleMiniDropdown('dd-nivel')">
                        <span><i class="fas fa-chart-line"></i> Codex</span>
                        <span class="mini-dropdown-count" id="count-nivel">0</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="dd-nivel" class="mini-dropdown-content">
                        <div class="input-row">
                            <label>Codex M칤n.</label>
                            <input type="number" id="codex_min" placeholder="0" onchange="atualizarCountNivel()">
                        </div>
                        <div class="input-row">
                            <label>Potencial M칤n.</label>
                            <input type="number" id="potencial_min" placeholder="0" onchange="atualizarCountNivel()">
                        </div>
                        <div class="input-row">
                            <label>Itens 칄picos/Lend.</label>
                            <input type="number" id="itens_comercio_min" placeholder="0" min="0" onchange="atualizarCountNivel()">
                        </div>
                        <button type="button" class="btn-aplicar" onclick="toggleMiniDropdown('dd-nivel')">Aplicar</button>
                    </div>
                </div>
                
                <!-- Dropdown Trade (Itens Comercializ치veis) -->
                <div class="mini-dropdown">
                    <button type="button" class="mini-dropdown-btn" onclick="toggleMiniDropdown('dd-trade')">
                        <span><i class="fas fa-balance-scale"></i> Trade</span>
                        <span class="mini-dropdown-count" id="count-trade">0</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="dd-trade" class="mini-dropdown-content">
                        <p style="font-size: 0.75rem; color: #a0aec0; margin-bottom: 10px;">
                            Filtrar por itens equipados comercializ치veis (com balan칞a)
                        </p>
                        <div class="input-row">
                            <label style="flex:2;">Equipamentos Lend치rios Trade</label>
                            <input type="number" id="equip_lend_trade_min" placeholder="0" min="0" onchange="atualizarCountTrade()">
                        </div>
                        <div class="input-row">
                            <label style="flex:2;">Equipamentos 칄picos Trade</label>
                            <input type="number" id="equip_epic_trade_min" placeholder="0" min="0" onchange="atualizarCountTrade()">
                        </div>
                        <button type="button" class="btn-aplicar" onclick="toggleMiniDropdown('dd-trade')">Aplicar</button>
                    </div>
                </div>
                
                <!-- Bot칚o Status Avan칞ados -->
                <button type="button" class="btn-acao-compacto" onclick="abrirModalStatus(event)">
                    <i class="fas fa-sliders-h"></i> Status
                </button>
                
                <!-- Bot칚o Filtro de Itens -->
                <button type="button" class="btn-acao-compacto" onclick="abrirModalItens(event)">
                    <i class="fas fa-box-open"></i> Itens
                </button>
                
                <!-- Bot칚o Filtro de Esp칤ritos -->
                <button type="button" class="btn-acao-compacto" onclick="abrirModalEspiritos(event)">
                    <i class="fas fa-ghost"></i> Esp칤ritos <span id="count-espiritos" class="mini-dropdown-count">0</span>
                </button>
                
                <!-- Busca por nome -->
                <input type="text" id="busca_nome" class="busca-nome" placeholder="Nome do jogador...">
                
                <!-- Bot칚o Buscar -->
                <button type="button" class="btn-buscar-principal" onclick="buscarContas()">
                    <i class="fas fa-search"></i> Buscar
                </button>
                
                {% if is_premium %}
                <!-- Bot칫es Cache (s칩 premium) -->
                <button type="button" class="btn-acao-compacto" onclick="carregarCacheTeste()" style="background: #333;">
                    <i class="fas fa-database"></i> Cache 10
                </button>
                <button type="button" class="btn-acao-compacto" onclick="carregarCacheCompleto()" style="background: #333;">
                    <i class="fas fa-database"></i> Cache Full
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Contador e tabs Listado/Com Lance -->
        <div class="contador-resultados">
            <div class="numero" id="total-nfts">0</div>
            <div class="texto">Total de NFTs (atualiza ao buscar)</div>
        </div>
        
        <div class="tabs-status">
            <button type="button" class="tab-status active" id="tab-listado" onclick="filtrarPorStatus('listado')">Listado</button>
            <button type="button" class="tab-status" id="tab-bidding" onclick="filtrarPorStatus('bidding')">Com Lance</button>
        </div>
        
        <!-- 츼rea de Resultados -->
        <main>
            <div id="resultados" class="contas-grid">
                <div class="sem-resultados">
                    <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                    <p>Configure os filtros e clique em Buscar</p>
                </div>
            </div>
            
            <div class="paginacao-container" id="paginacao-container" style="display: none;">
                <button class="btn-buscar" style="width: auto; padding: 10px 30px;" onclick="carregarMaisContas()">
                    Carregar Mais
                </button>
                <span id="info-paginacao" style="display: block; margin-top: 10px; color: #888;"></span>
            </div>
        </main>
        
        </div>
    </div>

    <!-- Modal de Esp칤ritos -->
    <div id="modal-espiritos" class="modal" onclick="fecharModalEspiritos()">
        <div class="modal-conteudo" onclick="event.stopPropagation()" style="max-width: 700px;">
            <div class="modal-cabecalho">
                <h2><i class="fas fa-ghost"></i> Filtro de Esp칤ritos</h2>
                <span class="fechar-modal" onclick="fecharModalEspiritos()">&times;</span>
            </div>
            <div class="modal-corpo">
                <p style="font-size: 0.85rem; color: #a0aec0; margin-bottom: 10px;">
                    Clique nos esp칤ritos que deseja filtrar. M치ximo de 13 por vez.
                </p>
                
                <h4 style="color: #f6e05e; margin: 15px 0 10px;">Esp칤ritos Lend치rios (Grade 5)</h4>
                <div class="espiritos-grid" id="espiritos-lendarios">
                    <!-- Lend치rios -->
                    <div class="espirito-item" data-nome="Alma do Drag칚o Branco" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_018.png" alt="Alma do Drag칚o Branco" title="Alma do Drag칚o Branco">
                    </div>
                    <div class="espirito-item" data-nome="Oroonki" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_010.png" alt="Oroonki" title="Oroonki">
                    </div>
                    <div class="espirito-item" data-nome="Baratan, a Besta Rel칙mpago" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_012.png" alt="Baratan" title="Baratan, a Besta Rel칙mpago">
                    </div>
                    <div class="espirito-item" data-nome="Gargas, o Vigia Verdejante" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_013.png" alt="Gargas" title="Gargas, o Vigia Verdejante">
                    </div>
                    <div class="espirito-item" data-nome="Mantata, o Bar칚o Azul" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_011.png" alt="Mantata" title="Mantata, o Bar칚o Azul">
                    </div>
                    <div class="espirito-item" data-nome="Anjo da Morte, o Ceifeiro de Almas" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_009.png" alt="Anjo da Morte" title="Anjo da Morte, o Ceifeiro de Almas">
                    </div>
                    <div class="espirito-item" data-nome="Energia do Dem칪nio do Vazio" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_014.png" alt="Energia do Dem칪nio" title="Energia do Dem칪nio do Vazio">
                    </div>
                    <div class="espirito-item" data-nome="Woosa, o S치bio do Deserto" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_015.png" alt="Woosa" title="Woosa, o S치bio do Deserto">
                    </div>
                    <div class="espirito-item" data-nome="Khalion, o Grande General" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_016.png" alt="Khalion" title="Khalion, o Grande General">
                    </div>
                    <div class="espirito-item" data-nome="Vendavalma, o Invocador do Vento" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_019.png" alt="Vendavalma" title="Vendavalma, o Invocador do Vento">
                    </div>
                    <div class="espirito-item" data-nome="Poipoi, o Drag칚o da Nuvem Negra" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_017.png" alt="Poipoi" title="Poipoi, o Drag칚o da Nuvem Negra">
                    </div>
                    <div class="espirito-item" data-nome="Flordoura, a Dragoa Fada" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_020.png" alt="Flordoura" title="Flordoura, a Dragoa Fada">
                    </div>
                    <div class="espirito-item" data-nome="Zakhan, o Assassino Sombrio" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_021.png" alt="Zakhan" title="Zakhan, o Assassino Sombrio">
                    </div>
                    <div class="espirito-item" data-nome="Zeon, o Drag칚o do Golpe de Rel칙mpago" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_022.png" alt="Zeon" title="Zeon, o Drag칚o do Golpe de Rel칙mpago">
                    </div>
                    <div class="espirito-item" data-nome="Lord do Deserto" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_023.png" alt="Lord do Deserto" title="Lord do Deserto">
                    </div>
                    <div class="espirito-item" data-nome="Grifavalo, o Garanh칚o Sombrio" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_024.png" alt="Grifavalo" title="Grifavalo, o Garanh칚o Sombrio">
                    </div>
                    <div class="espirito-item" data-nome="Nerr, o Dem칪nio de Gelo das Trevas" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_025.png" alt="Nerr" title="Nerr, o Dem칪nio de Gelo das Trevas">
                    </div>
                    <div class="espirito-item" data-nome="Mir, o Drag칚o Radiante" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_026.png" alt="Mir" title="Mir, o Drag칚o Radiante">
                    </div>
                    <div class="espirito-item" data-nome="C칚omandante, o Chefe Canino" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_027.png" alt="C칚omandante" title="C칚omandante, o Chefe Canino">
                    </div>
                </div>
                
                <h4 style="color: #9f7aea; margin: 20px 0 10px;">Esp칤ritos 칄picos (Grade 4)</h4>
                <div class="espiritos-grid" id="espiritos-epicos">
                    <!-- 칄picos -->
                    <div class="espirito-item" data-nome="Muumuu" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_001.png" alt="Muumuu" title="Muumuu">
                    </div>
                    <div class="espirito-item" data-nome="Chacha, o Mestre do Disfarce" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_002.png" alt="Chacha" title="Chacha, o Mestre do Disfarce">
                    </div>
                    <div class="espirito-item" data-nome="Tesouro Dourado" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_003.png" alt="Tesouro Dourado" title="Tesouro Dourado">
                    </div>
                    <div class="espirito-item" data-nome="For칞a Vital do Drag칚o" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_004.png" alt="For칞a Vital" title="For칞a Vital do Drag칚o">
                    </div>
                    <div class="espirito-item" data-nome="Suparna, o P치ssaro Dourado" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_005.png" alt="Suparna" title="Suparna, o P치ssaro Dourado">
                    </div>
                    <div class="espirito-item" data-nome="Cora칞칚o do Dem칪nio Negro" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_006.png" alt="Cora칞칚o Dem칪nio" title="Cora칞칚o do Dem칪nio Negro">
                    </div>
                    <div class="espirito-item" data-nome="Cora칞칚o de Capit칚o Yeticlops" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_007.png" alt="Yeticlops" title="Cora칞칚o de Capit칚o Yeticlops">
                    </div>
                    <div class="espirito-item" data-nome="Cometa, o Dono dos Chifres Vermelhos" onclick="toggleEspirito(this)">
                        <img src="https://file.mir4global.com/xdraco-thumb/Content/UI/Atlas_N_Resource/Temp/Pet/Pet_Spirit_008.png" alt="Cometa" title="Cometa, o Dono dos Chifres Vermelhos">
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button type="button" class="btn-aplicar" onclick="limparEspiritos()" style="background: #4a5568;">Limpar Sele칞칚o</button>
                    <button type="button" class="btn-aplicar" onclick="fecharModalEspiritos()">Aplicar Filtros</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Status Avan칞ados -->
    <div id="modal-status" class="modal" onclick="fecharModalStatus()">
        <div class="modal-conteudo" onclick="event.stopPropagation()">
            <div class="modal-cabecalho">
                <h2><i class="fas fa-sliders-h"></i> Filtros de Status Avan칞ados</h2>
                <span class="fechar-modal" onclick="fecharModalStatus()">&times;</span>
            </div>
            <div class="modal-corpo">
                <p style="font-size: 0.9rem; color: #a0aec0; margin-bottom: 15px;">
                    Defina valores m칤nimos para os status abaixo. Deixe em branco para ignorar.
                </p>
                
                <div class="modal-buscar">
                    <input type="text" id="busca-status" placeholder="Buscar status..." onkeyup="filtrarStatus()" 
                           style="width: 100%; padding: 10px; background: #2d3748; border: 1px solid #4a5568; color: white; border-radius: 5px;">
                </div>
                
                <div id="lista-status" style="max-height: 50vh; overflow-y: auto; padding-right: 10px; margin-top: 15px;">
                    {% for status in status_importantes %}
                        {% if not status.destaque %}
                        <div class="status-item" data-nome="{{ status.nome|lower }}" 
                             style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #4a5568;">
                            <div class="status-info">
                                <label style="font-size: 0.85rem; color: white;">{{ status.nome }}</label>
                            </div>
                            <div class="status-input">
                                <input type="number" id="status_{{ status.hash }}" 
                                       placeholder="0" 
                                       style="width: 100px; font-size: 0.9rem; padding: 6px 10px; background: #2d3748; border: 1px solid #4a5568; color: white; border-radius: 5px;"
                                       value="">
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <div class="modal-controles" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-modal btn-limpar" onclick="limparFiltrosStatus()" 
                            style="flex: 1; padding: 10px; background: #718096; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-trash-alt"></i> Limpar Todos
                    </button>
                    <button class="btn-modal btn-aplicar" onclick="fecharModalStatus()" 
                            style="flex: 1; padding: 10px; background: #4299e1; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-check"></i> Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Filtro de Itens -->
    <div id="modal-itens" class="modal" onclick="fecharModalItens()">
        <div class="modal-conteudo" onclick="event.stopPropagation()">
            <div class="modal-cabecalho">
                <h2><i class="fas fa-box-open"></i> Filtro de Itens</h2>
                <span class="fechar-modal" onclick="fecharModalItens()">&times;</span>
            </div>
            <div class="modal-corpo">
                <p style="font-size: 0.9rem; color: #a0aec0; margin-bottom: 15px;">
                    Busque itens pelo nome e defina a quantidade m칤nima. Deixe em branco para ignorar.
                </p>
                
                <div class="modal-buscar">
                    <input type="text" id="busca-item" placeholder="Buscar item..." onkeyup="filtrarItens()" 
                           style="width: 100%; padding: 10px; background: #2d3748; border: 1px solid #4a5568; color: white; border-radius: 5px;">
                </div>
                
                <div id="itens-selecionados" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;">
                    <!-- Itens selecionados aparecem aqui como tags -->
                </div>
                
                <div id="lista-itens" style="max-height: 40vh; overflow-y: auto; padding-right: 10px; margin-top: 15px;">
                    {% for item in itens_lista %}
                        <div class="item-filtro-item" data-nome="{{ item.nome|lower }}" data-hash="{{ item.hash }}"
                             style="display: none; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #4a5568; cursor: pointer;"
                             onclick="adicionarFiltroItem('{{ item.hash }}', '{{ item.nome }}')">
                            <div class="item-info" style="flex: 1;">
                                <label style="font-size: 0.85rem; color: white; cursor: pointer;">{{ item.nome }}</label>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div id="itens-filtro-ativos" style="margin-top: 15px; border-top: 1px solid #4a5568; padding-top: 15px;">
                    <h4 style="color: #f6e05e; margin-bottom: 10px;"><i class="fas fa-filter"></i> Filtros Ativos</h4>
                    <div id="itens-filtro-lista" style="max-height: 25vh; overflow-y: auto;">
                        <!-- Itens com filtro ativo -->
                    </div>
                </div>
                
                <div class="modal-controles" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-modal btn-limpar" onclick="limparFiltrosItens()" 
                            style="flex: 1; padding: 10px; background: #718096; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-trash-alt"></i> Limpar Todos
                    </button>
                    <button class="btn-modal btn-aplicar" onclick="fecharModalItens()" 
                            style="flex: 1; padding: 10px; background: #38a169; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-check"></i> Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Todos os Status -->
    <div id="modal-todos-status" class="modal" onclick="fecharModalTodosStatus()">
        <div class="modal-conteudo" onclick="event.stopPropagation()">
            <div class="modal-cabecalho">
                <h2><i class="fas fa-chart-bar"></i> Todos os Status</h2>
                <span class="fechar-modal" onclick="fecharModalTodosStatus()">&times;</span>
            </div>
            <div class="modal-corpo">
                <div class="modal-buscar">
                    <input type="text" id="buscar-status-modal" placeholder="Buscar status..."
                           style="width: 100%; padding: 10px; background: #2d3748; border: 1px solid #4a5568; color: white; border-radius: 5px;">
                </div>
                <div id="status-container" class="status-grid" style="margin-top: 15px;">
                    <!-- Status ser칚o carregados aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA칂칏ES GLOBAIS ---
        const ICONS_PATH = "{{ url_for('static', filename='icons/') }}";
        let cacheTipo = 'completas'; // Come칞a com teste
        let paginaAtual = 0;
        let todasContas = [];
        let filtrosAtuais = null;
        const LIMITE_POR_PAGINA = 10;
        let totalContasFiltradas = 0;
        let filtrosItensAtivos = {}; // {hash: {nome: string, qtd: number}}

        // Mapeamento de servidores por regi칚o
        const SERVIDORES = {
            "ASIA1": ["ASIA011", "ASIA012", "ASIA013", "ASIA014", "ASIA021", "ASIA022", "ASIA023", "ASIA024", "ASIA031", "ASIA032", "ASIA033", "ASIA041", "ASIA042", "ASIA043"],
            "ASIA2": ["ASIA051", "ASIA052", "ASIA053", "ASIA054", "ASIA061", "ASIA062", "ASIA063", "ASIA064", "ASIA071", "ASIA072", "ASIA073", "ASIA081", "ASIA082", "ASIA083"],
            "ASIA3": ["ASIA311", "ASIA312", "ASIA313", "ASIA314", "ASIA321", "ASIA322", "ASIA323", "ASIA324", "ASIA331", "ASIA332", "ASIA333", "ASIA341", "ASIA342", "ASIA343"],
            "ASIA4": ["ASIA351", "ASIA352", "ASIA353", "ASIA354", "ASIA361", "ASIA362", "ASIA363", "ASIA364", "ASIA371", "ASIA372", "ASIA373"],
            "INMENA1": ["INMENA011", "INMENA012", "INMENA013", "INMENA014", "INMENA021", "INMENA022", "INMENA023", "INMENA024"],
            "EU1": ["EU011", "EU012", "EU013", "EU014", "EU021", "EU022", "EU023", "EU024", "EU031", "EU032", "EU033", "EU034", "EU041", "EU042", "EU043"],
            "SA1": ["SA011", "SA012", "SA013", "SA014", "SA021", "SA022", "SA023", "SA031", "SA032", "SA033", "SA034", "SA041", "SA043", "SA044"],
            "SA2": ["SA051", "SA052", "SA053", "SA054", "SA061", "SA062", "SA064", "SA071", "SA072", "SA073", "SA081", "SA082", "SA083"],
            "NA1": ["NA011", "NA012", "NA013", "NA014", "NA021", "NA022", "NA023", "NA031", "NA032", "NA033", "NA034", "NA042", "NA043", "NA044"],
            "NA2": ["NA051", "NA052", "NA053", "NA054", "NA061", "NA062", "NA071", "NA072", "NA073", "NA074", "NA081", "NA082", "NA083", "NA084"]
        };

        // Fun칞칚o para atualizar dropdown de servidores com base na regi칚o selecionada
        function atualizarServidores() {
            const regiao = document.getElementById('regiao').value;
            const servidorSelect = document.getElementById('servidor');
            
            // Limpar op칞칫es atuais
            servidorSelect.innerHTML = '<option value="">Todos</option>';
            
            // Se uma regi칚o foi selecionada, adicionar os servidores dela
            if (regiao && SERVIDORES[regiao]) {
                SERVIDORES[regiao].forEach(servidor => {
                    const option = document.createElement('option');
                    option.value = servidor;
                    option.textContent = servidor;
                    servidorSelect.appendChild(option);
                });
            }
        }

        // --- INICIALIZA칂츾O ---
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar cache e carregar vitrine automaticamente
            verificarStatusCache().then(data => {
                if (data && (data.tem_cache_completo || data.tem_cache_teste)) {
                    // Seleciona o melhor cache dispon칤vel
                    if (data.tem_cache_completo && data.total_completo > 0) {
                        selecionarCache('completas');
                    } else if (data.tem_cache_teste && data.total_teste > 0) {
                        selecionarCache('teste');
                    }
                    // Carregar vitrine automaticamente (contas mais fortes)
                    setTimeout(() => {
                        buscarContas();
                    }, 300);
                }
            });
        });

        // --- FUN칂칏ES DO MODAL ---
        function abrirModalStatus(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const modal = document.getElementById('modal-status');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
            
            // Focar no campo de busca
            setTimeout(() => {
                document.getElementById('busca-status')?.focus();
            }, 50);
        }

        function fecharModalStatus() {
            const modal = document.getElementById('modal-status');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        // --- MODAL DE ESP칈RITOS ---
        let espiritosAtivos = new Set();
        const MAX_ESPIRITOS = 13;
        
        function abrirModalEspiritos(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const modal = document.getElementById('modal-espiritos');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }
        
        function fecharModalEspiritos() {
            const modal = document.getElementById('modal-espiritos');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
            atualizarCountEspiritos();
        }
        
        function toggleEspirito(el) {
            const nome = el.getAttribute('data-nome');
            
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                espiritosAtivos.delete(nome);
            } else {
                if (espiritosAtivos.size >= MAX_ESPIRITOS) {
                    mostrarNotificacao(`M치ximo de ${MAX_ESPIRITOS} esp칤ritos selecionados`, 'warning');
                    return;
                }
                el.classList.add('selected');
                espiritosAtivos.add(nome);
            }
            
            atualizarCountEspiritos();
        }
        
        function limparEspiritos() {
            espiritosAtivos.clear();
            document.querySelectorAll('.espirito-item.selected').forEach(el => {
                el.classList.remove('selected');
            });
            atualizarCountEspiritos();
        }
        
        function atualizarCountEspiritos() {
            const countEl = document.getElementById('count-espiritos');
            if (countEl) {
                countEl.textContent = espiritosAtivos.size;
                countEl.classList.toggle('has-value', espiritosAtivos.size > 0);
            }
        }

        function filtrarStatus() {
            const busca = document.getElementById('busca-status')?.value.toLowerCase() || '';
            const items = document.querySelectorAll('#lista-status .status-item');
            
            items.forEach(item => {
                const nome = item.getAttribute('data-nome');
                if (nome.includes(busca)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function limparFiltrosStatus() {
            if (confirm('Limpar todos os filtros de status?')) {
                document.querySelectorAll('#lista-status input').forEach(input => {
                    input.value = '';
                });
                
                const aceleramento = document.getElementById('status_aceleramento');
                const aconegro = document.getElementById('status_aconegro');
                const minaMin = document.getElementById('mina_min');
                
                if (aceleramento) aceleramento.value = '';
                if (aconegro) aconegro.value = '';
                if (minaMin) minaMin.value = '';
            }
        }

        // --- FUN칂칏ES DO MODAL DE ITENS ---
        function abrirModalItens(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const modal = document.getElementById('modal-itens');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
            
            // Focar no campo de busca
            setTimeout(() => {
                document.getElementById('busca-item')?.focus();
            }, 50);
            
            // Atualizar lista de filtros ativos
            atualizarListaFiltrosItens();
        }

        function fecharModalItens() {
            const modal = document.getElementById('modal-itens');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function filtrarItens() {
            const buscaOriginal = document.getElementById('busca-item')?.value || '';
            const busca = removerAcentos(buscaOriginal.toLowerCase().trim());
            const items = document.querySelectorAll('#lista-itens .item-filtro-item');
            
            let encontrados = 0;
            const maxResultados = 50; // Limitar resultados para performance
            
            items.forEach(item => {
                if (busca.length < 2) {
                    item.style.display = 'none';
                    return;
                }
                
                const nomeOriginal = item.getAttribute('data-nome') || '';
                const nomeSemAcento = removerAcentos(nomeOriginal);
                
                if (encontrados < maxResultados && nomeSemAcento.includes(busca)) {
                    item.style.display = 'flex';
                    encontrados++;
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function adicionarFiltroItem(hash, nome) {
            // Se j치 existe, n칚o adicionar novamente
            if (filtrosItensAtivos[hash]) {
                mostrarNotificacao('Este item j치 est치 na lista de filtros', 'warning');
                return;
            }
            
            // Adicionar com quantidade padr칚o 1
            filtrosItensAtivos[hash] = { nome: nome, qtd: 1 };
            
            // Limpar busca
            document.getElementById('busca-item').value = '';
            filtrarItens();
            
            // Atualizar lista
            atualizarListaFiltrosItens();
            
            mostrarNotificacao(`"${nome}" adicionado aos filtros`, 'success');
        }

        function removerFiltroItem(hash) {
            const nome = filtrosItensAtivos[hash]?.nome || '';
            delete filtrosItensAtivos[hash];
            atualizarListaFiltrosItens();
            mostrarNotificacao(`"${nome}" removido dos filtros`, 'success');
        }

        function atualizarQuantidadeItem(hash, qtd) {
            if (filtrosItensAtivos[hash]) {
                filtrosItensAtivos[hash].qtd = parseInt(qtd) || 1;
            }
        }

        function atualizarListaFiltrosItens() {
            const container = document.getElementById('itens-filtro-lista');
            
            if (Object.keys(filtrosItensAtivos).length === 0) {
                container.innerHTML = '<p style="color: #a0aec0; font-style: italic;">Nenhum filtro de item ativo. Busque e clique em um item para adicionar.</p>';
                return;
            }
            
            let html = '';
            for (const [hash, data] of Object.entries(filtrosItensAtivos)) {
                html += `
                    <div class="item-filtro-ativo" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #4a5568;">
                        <div style="flex: 1; color: white; font-size: 0.85rem;" title="${data.nome}">${data.nome}</div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label style="color: #a0aec0; font-size: 0.8rem;">M칤n:</label>
                            <input type="number" value="${data.qtd}" min="1" 
                                   style="width: 60px; padding: 5px; background: #2d3748; border: 1px solid #4a5568; color: white; border-radius: 3px;"
                                   onchange="atualizarQuantidadeItem('${hash}', this.value)">
                        </div>
                        <button onclick="removerFiltroItem('${hash}')" 
                                style="background: #e53e3e; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function limparFiltrosItens() {
            filtrosItensAtivos = {};
            atualizarListaFiltrosItens();
            mostrarNotificacao('Filtros de itens limpos', 'success');
        }

        // --- FUN칂칏ES DO MODAL DE TODOS OS STATUS ---
        function abrirModalTodosStatus(event) {
            event.stopPropagation();
            
            try {
                const statsStr = event.currentTarget.getAttribute('data-stats');
                if (!statsStr) return;
                
                const stats = JSON.parse(statsStr);
                preencherModalStatus(stats);
                
                const modal = document.getElementById('modal-todos-status');
                modal.style.display = 'block';
                setTimeout(() => {
                    modal.style.opacity = '1';
                }, 10);
                
                setTimeout(() => {
                    document.getElementById('buscar-status-modal')?.focus();
                }, 50);
                
            } catch (error) {
                console.error('Erro ao abrir modal de status:', error);
                mostrarNotificacao('Erro ao carregar status', 'error');
            }
        }

        function fecharModalTodosStatus() {
            const modal = document.getElementById('modal-todos-status');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('buscar-status-modal').value = '';
            }, 300);
        }

        function preencherModalStatus(stats) {
            const container = document.getElementById('status-container');
            container.innerHTML = '';
            
            // Garantir que stats seja um array
            let statsArray = stats;
            if (!Array.isArray(stats)) {
                if (stats && typeof stats === 'object') {
                    // Se for um objeto, tentar extrair como array
                    statsArray = stats.lists || stats.data || Object.values(stats);
                } else {
                    statsArray = [];
                }
            }
            
            if (!statsArray || statsArray.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #a0aec0;">
                        <i class="fas fa-info-circle"></i>
                        <p>Nenhum status dispon칤vel para esta conta.</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar por nome
            const statsOrdenados = [...statsArray].sort((a, b) => 
                a.statName?.localeCompare(b.statName || '') || 0
            );
            
            statsOrdenados.forEach(stat => {
                const div = document.createElement('div');
                div.className = 'status-item-modal';
                div.style.cssText = 'display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #4a5568;';
                
                const valorFormatado = formatarValorStatus(stat.statValue || '0');
                
                div.innerHTML = `
                    <div class="status-icon-modal" style="margin-right: 15px;">
                        ${stat.iconPath ? 
                            `<img src="${stat.iconPath}" alt="${stat.statName}" style="width: 32px; height: 32px;">` : 
                            `<i class="fas fa-chart-line" style="font-size: 24px; color: #4299e1;"></i>`
                        }
                    </div>
                    <div class="status-info-modal" style="flex: 1;">
                        <div class="status-name-modal" title="${stat.statName || ''}" style="color: white; font-size: 0.9rem;">
                            ${stat.statName || 'Status'}
                        </div>
                        <div class="status-value-modal" style="color: #f6e05e; font-weight: bold; font-size: 1rem;">
                            ${valorFormatado}
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function formatarValorStatus(valor) {
            if (!valor || valor === 'null' || valor === 'undefined' || valor === '') {
                return '0';
            }
            
            if (valor.toString().includes('%')) {
                return valor.toString();
            }
            
            let numero = valor.toString().replace(/,/g, '');
            if (numero.includes(',') && !numero.includes('.')) {
                numero = numero.replace(',', '.');
            }
            
            const num = parseFloat(numero);
            if (isNaN(num)) {
                return valor.toString();
            }
            
            if (num % 1 === 0) {
                return Math.round(num).toLocaleString('pt-BR');
            }
            
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(2) + 'B';
            } else if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            
            return num.toFixed(2);
        }

        function mostrarNotificacao(mensagem, tipo = 'info') {
            const notifAnterior = document.querySelector('.notification');
            if (notifAnterior) {
                notifAnterior.remove();
            }
            
            const notificacao = document.createElement('div');
            notificacao.className = `notification ${tipo}`;
            
            let icone = 'info-circle';
            if (tipo === 'success') icone = 'check-circle';
            if (tipo === 'error') icone = 'exclamation-circle';
            if (tipo === 'warning') icone = 'exclamation-triangle';
            
            notificacao.innerHTML = `
                <i class="fas fa-${icone}"></i>
                <span>${mensagem}</span>
            `;
            
            document.body.appendChild(notificacao);
            
            setTimeout(() => {
                notificacao.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notificacao.classList.remove('show');
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        notificacao.remove();
                    }
                }, 300);
            }, 4000);
        }

        // --- FUN칂칏ES DE FORMATA칂츾O ---
        function formatarNumero(num) {
            if (num === undefined || num === null) return "0";
            if (typeof num === 'string') {
                num = parseFloat(num.replace(/,/g, ''));
            }
            if (isNaN(num)) return "0";
            
            if (num >= 1000) {
                return num.toLocaleString('pt-BR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }
            
            if (num % 1 !== 0) {
                return num.toFixed(1).replace('.', ',');
            }
            
            return num.toString();
        }

        function formatarPorcentagem(num) {
            if (num === undefined || num === null) return "0%";
            if (typeof num === 'string') {
                num = parseFloat(num.replace(/,/g, ''));
            }
            if (isNaN(num)) return "0%";
            return num.toFixed(1) + "%";
        }

        // --- FUN칂츾O AUXILIAR PARA RENDERIZAR ITENS ---
        function renderItemIcon(item) {
            if (!item) {
                return '<div class="item-circle" style="border-style: dashed; border-color: #444; background: rgba(0,0,0,0.3);"><i class="fas fa-question"></i></div>';
            }
            
            const gradeClass = `grade-${item.grade || 1}`;
            const enhanceHtml = item.enhance > 0 ? `<div class="badge-enhance">+${item.enhance}</div>` : '';
            
            // Tier em Romano
            const tiers = ["", "T1", "T2", "T3", "T4", "T5"];
            const tierHtml = item.tier > 0 ? `<div class="badge-tier">${tiers[item.tier] || 'I'}</div>` : '';
            
            // Trade - Agora usando imagem personalizada
            const tradeHtml = item.trade ? `<div class="badge-trade" title="Item Negoci치vel"></div>` : '';
            
            // Quantidade
            const countHtml = item.count > 1 ? `<div class="badge-count">${item.count}</div>` : '';

            // Se n칚o tiver imagem, usar 칤cone com fundo da raridade
            if (!item.img || item.img === '') {
                return `
                <div class="item-circle ${gradeClass} no-img" title="${item.name || ''}">
                    <i class="fas fa-box" style="color: rgba(255,255,255,0.8);"></i>
                    ${enhanceHtml}
                    ${tierHtml}
                    ${tradeHtml}
                    ${countHtml}
                </div>
                `;
            }
            

            // Com imagem - background da imagem com overlay da raridade
            return `
            <div class="item-circle ${gradeClass}" 
                 style="background-image: url('${item.img}');" 
                 title="${item.name || ''}">
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: inherit; border-radius: 10px;"></div>
                ${enhanceHtml}
                ${tierHtml}
                ${tradeHtml}
                ${countHtml}
            </div>
            `;
        }

        // --- FUN칂츾O PARA RENDERIZAR ITENS ESPECIAIS (BILHETES, CRISTAIS, FRAGMENTOS) ---
        function renderSpecialItem(item) {
            if (!item) {
                return '<div class="item-circle" style="border-style: dashed; border-color: #444; background: rgba(0,0,0,0.3);"><i class="fas fa-question"></i></div>';
            }
            
            const gradeClass = `grade-${item.grade || 1}`;
            const countHtml = item.count > 1 ? `<div class="badge-count">${item.count}</div>` : '';
            
            // Se n칚o tiver imagem, usar 칤cone com fundo da raridade
            if (!item.img || item.img === '') {
                return `
                <div class="item-circle ${gradeClass} no-img" title="${item.name || ''}">
                    <i class="fas fa-box" style="color: rgba(255,255,255,0.8);"></i>
                    ${countHtml}
                </div>
                `;
            }
            
            // Com imagem
            return `
            <div class="item-circle ${gradeClass}" 
                 style="background-image: url('${item.img}');" 
                 title="${item.name || ''}">
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: inherit; border-radius: 10px;"></div>
                ${countHtml}
            </div>
            `;
        }

        // Fun칞칚o para ordenar itens especiais por raridade (칄pico > Raro > Incomum) e depois por nome
        function ordenarItensEspeciais(itens) {
            if (!itens || itens.length === 0) {
                return itens;
            }
            
            // Pesos de raridade
            const pesosRaridade = {
                '칄pico': 3,
                'Raro': 2,
                'Incomum': 1
            };
            
            return itens.sort((a, b) => {
                const nomeA = a.name || '';
                const nomeB = b.name || '';
                
                // Extrai a raridade da 칰ltima palavra do nome
                const raridadeA = nomeA.split(' ').pop();
                const raridadeB = nomeB.split(' ').pop();
                
                const pesoA = pesosRaridade[raridadeA] || 0;
                const pesoB = pesosRaridade[raridadeB] || 0;
                
                // Primeiro ordena por raridade (decrescente)
                if (pesoA !== pesoB) {
                    return pesoB - pesoA; // 칄pico (3) vem antes de Raro (2)
                }
                
                // Se mesma raridade, ordena por nome
                return nomeA.localeCompare(nomeB);
            });
        }
        
        // --- CONSTRUTOR DO CARD ---
        function criarCardConta(conta) {
           // L칩gica de cores por faixa de poder
		   // No in칤cio da fun칞칚o criarCardConta, adicione:
console.log(`[DEBUG CARD] Criando card para conta ${conta.seq}`);
console.log(`[DEBUG CARD] inven_total: ${conta.inven_total}`);
console.log(`[DEBUG CARD] inven_all length: ${conta.inven_all ? conta.inven_all.length : 0}`);
console.log(`[DEBUG CARD] inven length: ${conta.inven ? conta.inven.length : 0}`);
    let cardType = 'type-blue'; // Padr칚o para 239.999 pra baixo
    const poder = conta.powerScore;

    if (poder >= 400000) {
        cardType = 'type-gold';
    } else if (poder >= 249000) {
        cardType = 'type-red';
    } else {
        cardType = 'type-blue';
    }
            
            // Imagem da classe
            const imgClass = conta.class.imagem ? 
                `<img src="${ICONS_PATH}${conta.class.imagem}" alt="${conta.class.nome}" style="width: 60px; height: 60px;">` : 
                `<span style="font-size: 40px;">${conta.class.icone}</span>`;

            // Formata칞칚o
           // Adicione estas vari치veis na fun칞칚o que monta o card:
// Adicione esta vari치vel junto com as outras:
const phyAtk = formatarNumero(conta.ataque_fisico);
const magAtk = formatarNumero(conta.ataque_magico);
const crit = formatarNumero(conta.critico);
const precisao = formatarNumero(conta.precisao);
const atkHabilidade = formatarNumero(conta.atk_habilidade) + '%';
const evasao = formatarNumero(conta.evasao);
const miningBoost = formatarNumero(conta.aceleramento_mineracao) + '%';
const darksteelBoost = formatarNumero(conta.aumento_aconegro) + '%';
            const priceUsd = conta.price_brl ? `(R$ ${conta.price_brl.toLocaleString('pt-BR')})` : '($ --)';

            // Preparar dados
            const equips = Array.isArray(conta.equip) ? conta.equip : [];
            const spirits = Array.isArray(conta.spirit_list) ? conta.spirit_list : [];
            const skills = Array.isArray(conta.skills_list) ? conta.skills_list : [];
            const inventory = Array.isArray(conta.inven) ? conta.inven : [];
            const training = conta.training_details || { constituicao: 0, inner_force: [] };

            // Aba 0: Info Geral
            const tab0Content = `
                <div class="card-avatar-section">
                    <div class="class-name-vertical">${conta.class.nome}</div>
                    <div class="diamond-shape">
                        ${imgClass}
                    </div>
                </div>

                <div class="card-main-info">
                    <div class="card-level">LV. ${conta.level}</div>
                    <div class="card-power">${formatarNumero(conta.powerScore)}</div>
                    <div class="card-player-name">${conta.name}</div>
                </div>

                <div class="card-stats-grid">
                    <div class="stat-box">
                        <label>ATAQUE F칈SICO</label>
                        <span>${phyAtk}</span>
                    </div>
                    <div class="stat-box">
                        <label>ATAQUE M츼GICO</label>
                        <span>${magAtk}</span>
                    </div>
                    <div class="stat-box">
                        <label>Cr칤tico</label>
                        <span>${crit}</span>
                    </div>
                    <div class="stat-box">
                        <label>[L] Esp칤ritos</label>
                        <span>${conta.pets?.lendarios || 0}</span>
                    </div>
                    <div class="stat-box">
                        <label>[L] HABILIDADES</label>
                        <span>${conta.skills?.lendarias || 0}</span>
                    </div>
                    <div class="stat-box">
                        <label>Codex</label>
                        <span>${conta.codex || 0}</span>
                    </div>
					<div class="stat-box">
    <label>Precis칚o</label>
    <span>${precisao}</span>
</div>
<div class="stat-box">
    <label>aumento de atk de hab</label>
    <span>${atkHabilidade}</span>
</div>
<div class="stat-box">
    <label>Evas칚o</label>
    <span>${evasao}</span>
</div>
<div class="stat-box">
                        <label>Minera칞칚o</label>
                        <span>${miningBoost}</span>
                    </div>
<div class="stat-box">
                        <label>A칞o Negro</label>
                        <span>${darksteelBoost}</span>
                    </div>			
<div class="stat-box">
                        <label>Mina</label>
                        <span>${conta.mina || 0}</span>
                    </div>					
                </div>
				
				
            `;

            // Aba 1: Equip, Esp칤ritos, Skills
            const equipsHtml = equips.length ? 
                equips.map(item => renderItemIcon(item)).join('') : 
                '<p style="grid-column:1/-1; text-align:center; font-size:0.8rem; color:#718096;">Sem equipamentos</p>';
                
            const spiritsHtml = spirits.length ? 
                spirits.map(item => renderItemIcon(item)).join('') : 
                '<p style="grid-column:1/-1; text-align:center; font-size:0.8rem; color:#718096;">Sem esp칤ritos</p>';
                
            const skillsHtml = skills.length ? 
                skills.map(item => renderItemIcon(item)).join('') : 
                '<p style="grid-column:1/-1; text-align:center; font-size:0.8rem; color:#718096;">Sem habilidades</p>';

            const tab1Content = `
                <center><div class="section-title">Equipamentos</div>
                <div class="items-grid">${equipsHtml}</div>
                
                <div class="section-title">Esp칤ritos</div>
                <div class="items-grid">${spiritsHtml}</div>

                <div class="section-title">Habilidades</div>
                <div class="items-grid no-tier">${skillsHtml}</div></center>
            `;

            // Aba 2: Treino
            let forceHtml = '';
            if (training.inner_force && training.inner_force.length > 0) {
                forceHtml = training.inner_force.map(f => `
                    <div class="stat-box">
                        <label>${f.name || 'For칞a'}</label>
                        <span style="color: ${f.level >= 10 ? '#f6e05e' : '#fff'}">${f.level || 0}</span>
                    </div>
                `).join('');
            } else {
                forceHtml = '<p style="grid-column:1/-1; text-align:center; font-size:0.8rem; color:#718096;">Sem dados de for칞a interna</p>';
            }

            const tab2Content = `
                <div style="margin-top: 20px;">
                    <div class="training-box">
                        <div class="training-lbl">CONSTITUI칂츾O</div>
                        <div class="training-val">${training.constituicao || conta.constituicao || 0}</div>
                    </div>
                    
                    
                    <div class="card-stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                        ${forceHtml}
                    </div>
                     
                    <center><div class="training-lbl">Potencial</div><center>
                     <div class="training-box" style="padding: 5px;">
                        <div class="training-val" style="font-size: 1rem;">${conta.potencial || 0}</div>
                    </div>
                </div>
            `;

            // Aba 3: Invent치rio - VERS츾O CORRIGIDA
            const inven = conta.inven_all || []; // Todos os itens
            const invenInicial = conta.inven || []; // Primeiros 12 itens

            // IMPORTANTE: invenTotal deve vir do backend se dispon칤vel
            const invenTotal = conta.inven_total || inven.length || 0;

            // Verificar se temos mais itens do que os iniciais
            const temMaisItens = invenTotal > invenInicial.length;

            console.log(`[DEBUG] Conta ${conta.seq}: invenTotal=${invenTotal}, invenInicial=${invenInicial.length}, temMaisItens=${temMaisItens}`);

            const invenHtml = invenInicial.length ? 
                invenInicial.map(item => renderItemIcon(item)).join('') : 
                '<div style="text-align:center; padding:20px; color:#718096; font-size:0.9rem;">Sem itens negoci치veis</div>';

            const carregarMaisBtn3 = temMaisItens ? 
                `<button class="carregar-mais-btn" onclick="carregarMaisInventario('${conta.seq}')" 
                        id="carregar-mais-btn-${conta.seq}">
                    <i class="fas fa-plus"></i> Carregar mais itens (${invenTotal - invenInicial.length} restantes)
                </button>` : '';

            const tab3Content = `
                <center><div class="section-title">Top Itens Negoci치veis</div></center>
                <div class="items-grid" id="inven-items-${conta.seq}">
                    ${invenHtml}
                </div>
                ${carregarMaisBtn3}
            `;

            // Aba 4: Bilhetes
            // HTML para Bilhetes (ordenar apenas por nome)
            const tickets = Array.isArray(conta.tickets) ? ordenarItensEspeciais(conta.tickets) : [];
            const ticketsHtml = tickets.length > 0 ? 
                tickets.map(item => renderSpecialItem(item)).join('') : 
                '<div style="text-align:center; padding:20px; color:#718096; font-size:0.9rem;">Sem bilhetes</div>';

            // HTML para Cristais (ordenar por raridade e nome)
            const crystals = Array.isArray(conta.crystals) ? ordenarItensEspeciais(conta.crystals) : [];
            const crystalsHtml = crystals.length > 0 ? 
                crystals.map(item => renderSpecialItem(item)).join('') : 
                '<div style="text-align:center; padding:20px; color:#718096; font-size:0.9rem;">Sem cristais</div>';

            // HTML para Fragmentos (ordenar por raridade e nome)
            const fragments = Array.isArray(conta.fragments) ? ordenarItensEspeciais(conta.fragments) : [];
            const fragmentsHtml = fragments.length > 0 ? 
                fragments.map(item => renderSpecialItem(item)).join('') : 
                '<div style="text-align:center; padding:20px; color:#718096; font-size:0.9rem;">Sem fragmentos</div>';
            
            // Estrutura do Card
            return `
            <div class="nft-card ${cardType}" id="card-${conta.seq}">
                <div class="card-top-bar">
                    <span class="card-status-badge">LISTADO</span>
                    <span class="card-price-top">${conta.price.toLocaleString()} WEMIX</span>
                </div>

                <div class="card-tabs">
                    <button class="card-tab-btn active" onclick="switchCardTab(this, ${conta.seq}, 0)"><i class="fas fa-home"></i></button>
                    <button class="card-tab-btn" onclick="switchCardTab(this, ${conta.seq}, 1)"><i class="fas fa-tshirt"></i></button>
                    <button class="card-tab-btn" onclick="switchCardTab(this, ${conta.seq}, 2)"><i class="fas fa-dumbbell"></i></button>
                    <button class="card-tab-btn" onclick="switchCardTab(this, ${conta.seq}, 3)"><i class="fas fa-box-open"></i></button>
                    <!-- NOVOS BOT칏ES DAS ABAS ESPECIAIS -->
                    <button class="card-tab-btn" onclick="switchCardTab(this, ${conta.seq}, 4)"><i class="fas fa-ticket-alt"></i></button>
                    <button class="card-tab-btn" onclick="switchCardTab(this, ${conta.seq}, 5)"><i class="fas fa-gem"></i></button>
                    <button class="card-tab-btn" onclick="switchCardTab(this, ${conta.seq}, 6)"><i class="fas fa-shapes"></i></button>
                </div>

                <div class="tab-content active" data-tab="0">
                    ${tab0Content}
                </div>
                
                <div class="tab-content" data-tab="1">
                    ${tab1Content}
                </div>
                
                <div class="tab-content" data-tab="2">
                    ${tab2Content}
                </div>

                <div class="tab-content" data-tab="3">
                    ${tab3Content}
                </div>

                <!-- NOVAS ABAS ESPECIAIS -->
                <div class="tab-content" data-tab="4">
                    <center><div class="section-title">Bilhetes</div></center>
                    <div class="items-grid" id="tickets-items-${conta.seq}">
                        ${ticketsHtml}
                    </div>
                </div>

                <div class="tab-content" data-tab="5">
                    <center><div class="section-title">Cristais de Pico</div></center>
                    <div class="items-grid" id="crystals-items-${conta.seq}">
                        ${crystalsHtml}
                    </div>
                </div>

                <div class="tab-content" data-tab="6">
                    <center><div class="section-title">Fragmentos da Pra칞a</div></center>
                    <div class="items-grid" id="fragments-items-${conta.seq}">
                        ${fragmentsHtml}
                    </div>
                </div>

                <a href="${conta.url}" target="_blank" class="card-action-btn" style="margin-top: auto;">
                    <div class="wemix-display">
                        <i class="fas fa-external-link-alt"></i>
                        ${conta.price.toLocaleString()} WEMIX
                    </div>
                    <div class="usd-display">${priceUsd}</div>
                </a>
                
                <button class="btn-todos-status" onclick="abrirModalTodosStatus(event)" 
                        data-stats='${JSON.stringify(Array.isArray(conta.stats) ? conta.stats : []).replace(/'/g, "&apos;")}'>
                    <i class="fas fa-list"></i> Todos os Status
                </button>

                <div class="card-footer-info">
    <span class="world-name">${conta.worldName}</span>
</div>
            </div>
            `;
        }

        // --- FUN칂칏ES DE INTERA칂츾O ---
        function switchCardTab(btn, cardSeq, tabIndex) {
            const card = document.getElementById(`card-${cardSeq}`);
            if (!card) return;

            // Remove active de todos os bot칫es e abas
            card.querySelectorAll('.card-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            card.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Se for uma das abas especiais (4, 5, 6) e ainda n칚o foi carregada, mostrar loading
            const targetTab = card.querySelector(`.tab-content[data-tab="${tabIndex}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
                
                // Verificar se a aba j치 foi carregada
                if (tabIndex > 1 && !targetTab.dataset.loaded) {
                    // Mostrar loading
                    const originalHTML = targetTab.innerHTML;
                    targetTab.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p style="margin-top: 10px;">Carregando...</p>
                        </div>
                    `;
                    
                    // Simular carregamento (na pr치tica, os dados j치 est칚o carregados)
                    setTimeout(() => {
                        targetTab.innerHTML = originalHTML;
                        targetTab.dataset.loaded = 'true';
                    }, 100);
                }
            }
        }

        // Fun칞칚o para carregar mais itens do invent치rio
        function carregarMaisInventario(cardSeq) {
            const card = document.getElementById(`card-${cardSeq}`);
            const btn = document.getElementById(`carregar-mais-btn-${cardSeq}`);
            const container = document.getElementById(`inven-items-${cardSeq}`);
            
            if (!card || !btn || !container) {
                console.error(`Elementos n칚o encontrados para card ${cardSeq}`);
                return;
            }
            
            // Encontrar a conta nos dados
            const conta = todasContas.find(c => String(c.seq) === String(cardSeq));
            
            if (!conta) {
                console.error(`Conta ${cardSeq} n칚o encontrada`);
                return;
            }
            
            // Usar inven_all que tem TODOS os itens
            const todosItens = conta.inven_all || [];
            const itensJaMostrados = container.querySelectorAll('.item-circle').length;
            
            if (itensJaMostrados >= todosItens.length) {
                btn.innerHTML = '<i class="fas fa-check"></i> Todos os itens carregados';
                btn.disabled = true;
                setTimeout(() => { btn.style.display = 'none'; }, 2000);
                return;
            }
            
            // Mostrar loading no bot칚o
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';
            btn.disabled = true;
            
            // Pequeno delay para feedback visual
            setTimeout(() => {
                const itemsPerPage = 12;
                const inicio = itensJaMostrados;
                const fim = Math.min(inicio + itemsPerPage, todosItens.length);
                const proximosItens = todosItens.slice(inicio, fim);
                
                if (proximosItens.length === 0) {
                    btn.innerHTML = '<i class="fas fa-check"></i> Todos os itens carregados';
                    btn.disabled = true;
                    setTimeout(() => { btn.style.display = 'none'; }, 2000);
                    return;
                }
                
                // Adicionar os novos itens ao container
                const novosItensHtml = proximosItens.map(item => renderItemIcon(item)).join('');
                container.insertAdjacentHTML('beforeend', novosItensHtml);
                
                // Atualizar o bot칚o
                const novosTotal = itensJaMostrados + proximosItens.length;
                const restantes = todosItens.length - novosTotal;
                
                if (restantes > 0) {
                    btn.innerHTML = `<i class="fas fa-plus"></i> Carregar mais itens (${restantes} restantes)`;
                    btn.disabled = false;
                } else {
                    btn.innerHTML = '<i class="fas fa-check"></i> Todos os itens carregados';
                    btn.disabled = true;
                    setTimeout(() => { btn.style.display = 'none'; }, 2000);
                }
            }, 300);
        }

        // --- BUSCA E FILTROS ---
        function buscarContas() {
            const resultados = document.getElementById('resultados');
            resultados.innerHTML = '<div class="loading"><i class="fas fa-circle-notch fa-spin fa-2x"></i><p>Carregando dados...</p></div>';
            
            paginaAtual = 0;
            todasContas = [];
            
            const params = new URLSearchParams();
            params.append('cache_tipo', cacheTipo);
            params.append('pagina', paginaAtual);
            params.append('limite', LIMITE_POR_PAGINA);
            
            // Busca por nome
            const buscaNome = document.getElementById('busca_nome');
            if (buscaNome && buscaNome.value.trim()) {
                params.append('nome_jogador', buscaNome.value.trim());
            }
            
            // Filtro por status (listado/bidding)
            if (filtroStatusAtual) {
                params.append('status_lance', filtroStatusAtual);
            }
            
            // Filtros de Treino
            const treinoIds = ['treino_constituicao', 'treino_muscular', 'treino_noveyin', 'treino_noveyang', 'treino_sapo'];
            treinoIds.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.value && parseFloat(el.value) > 0) {
                    params.append(id, el.value);
                }
            });
            
            // Filtros de Esp칤ritos
            if (espiritosAtivos.size > 0) {
                params.append('espiritos', Array.from(espiritosAtivos).join(','));
            }
            
            // Filtros de Trade (itens comercializ치veis)
            const equipLendTrade = document.getElementById('equip_lend_trade_min')?.value;
            const equipEpicTrade = document.getElementById('equip_epic_trade_min')?.value;
            if (equipLendTrade && parseInt(equipLendTrade) > 0) {
                params.append('equip_lend_trade_min', equipLendTrade);
            }
            if (equipEpicTrade && parseInt(equipEpicTrade) > 0) {
                params.append('equip_epic_trade_min', equipEpicTrade);
            }
            
            // Coleta filtros b치sicos
            const ids = [
                'classe', 'power_min', 'power_max', 'level_min', 'level_max', 
                'price_min', 'price_max', 'mina_min', 'codex_min', 'potencial_min',
                'pets_lendarios_min', 'pets_misticos_min', 'habs_lendarias_min',
                'constituicao_min', 'itens_comercio_min', 'regiao', 'servidor'
            ];
            
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.value) params.append(id, el.value);
            });

            // Status de minera칞칚o - IMPORTANTE: usar os IDs corretos
            const aceleramento = document.getElementById('status_aceleramento');
            const aconegro = document.getElementById('status_aconegro');
            
            // Use o hash do status para os par칙metros
            {% for status in status_importantes %}
                {% if status.destaque and "Aceleramento de Minera칞칚o" in status.nome %}
                    if (aceleramento && aceleramento.value) {
                        params.append('status_{{ status.hash }}', aceleramento.value);
                    }
                {% endif %}
                {% if status.destaque and "Aumento de Ganho de A칞o Negro" in status.nome %}
                    if (aconegro && aconegro.value) {
                        params.append('status_{{ status.hash }}', aconegro.value);
                    }
                {% endif %}
            {% endfor %}

            // Status din칙micos do modal
            document.querySelectorAll('#lista-status input').forEach(input => {
                if (input.value) params.append(input.id, input.value);
            });

            // Filtros de itens espec칤ficos
            for (const [hash, data] of Object.entries(filtrosItensAtivos)) {
                params.append(`item_${hash}`, data.qtd);
            }

            // Ordena칞칚o
            const ordenacao = document.getElementById('ordenacao').value;
            if (ordenacao.includes('price')) {
                params.append('ordenar_por', 'price');
                params.append('ordenar_desc', ordenacao === 'price_desc');
            } else if (ordenacao === 'aceleramento' || ordenacao === 'aconegro') {
                params.append('ordenar_por', ordenacao);
                params.append('ordenar_desc', 'true');
            } else {
                params.append('ordenar_por', ordenacao);
                params.append('ordenar_desc', 'true');
            }

            filtrosAtuais = params;

            fetch(`/buscar-contas?${params.toString()}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        todasContas = data.contas || [];
                        totalContasFiltradas = data.total_filtrado || 0;
                        renderizarResultados(todasContas);
                        
                        // Mostrar notifica칞칚o com status aplicados
                        const statusFiltros = Array.from(params.entries())
                            .filter(([key]) => key.startsWith('status_'))
                            .map(([key, value]) => `${key.replace('status_', '')}: ${value}`);
                        
                        if (statusFiltros.length > 0) {
                            mostrarNotificacao(`${statusFiltros.length} filtro(s) de status aplicado(s)`, 'success');
                        }
                    } else {
                        resultados.innerHTML = `<div class="sem-resultados"><p>${data.error}</p></div>`;
                    }
                })
                .catch(e => {
                    console.error("Erro na busca:", e);
                    resultados.innerHTML = '<div class="sem-resultados"><p>Erro de conex칚o</p></div>';
                });
        }

        function carregarMaisContas() {
            paginaAtual++;
            const btn = document.querySelector('.paginacao-container button');
            if (!btn) return;
            
            const originalText = btn.innerText;
            btn.innerText = "Carregando...";
            btn.disabled = true;

            filtrosAtuais.set('pagina', paginaAtual);

            fetch(`/buscar-contas?${filtrosAtuais.toString()}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.contas && data.contas.length > 0) {
                        todasContas = [...todasContas, ...data.contas];
                        renderizarResultados(todasContas);
                    }
                    btn.innerText = originalText;
                    btn.disabled = false;
                })
                .catch(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }

        function renderizarResultados(contas) {
            const resultados = document.getElementById('resultados');
            const pagContainer = document.getElementById('paginacao-container');
            const infoPag = document.getElementById('info-paginacao');

            if (contas.length === 0) {
                resultados.innerHTML = `
                    <div class="sem-resultados">
                        <i class="fas fa-ghost fa-2x"></i>
                        <h3>Nenhuma conta encontrada</h3>
                        <p>Tente diminuir os filtros.</p>
                    </div>`;
                pagContainer.style.display = 'none';
                return;
            }

            resultados.innerHTML = contas.map(conta => criarCardConta(conta)).join('');
            
            if (contas.length < totalContasFiltradas) {
                pagContainer.style.display = 'flex';
                pagContainer.style.flexDirection = 'column';
                pagContainer.style.alignItems = 'center';
                infoPag.textContent = `Mostrando ${contas.length} de ${totalContasFiltradas}`;
            } else {
                pagContainer.style.display = 'none';
            }
        }

        // --- UI FUNCTIONS ---
        
        // Mini Dropdowns
        function toggleMiniDropdown(id) {
            const dropdown = document.getElementById(id);
            const allDropdowns = document.querySelectorAll('.mini-dropdown-content');
            
            // Fecha outros dropdowns
            allDropdowns.forEach(dd => {
                if (dd.id !== id) {
                    dd.classList.remove('show');
                }
            });
            
            dropdown.classList.toggle('show');
        }
        
        // Fecha dropdowns ao clicar fora
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.mini-dropdown')) {
                document.querySelectorAll('.mini-dropdown-content').forEach(dd => {
                    dd.classList.remove('show');
                });
            }
        });
        
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            const parent = dropdown.closest('.dropdown-filtro');
            
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                parent.classList.add('open');
            } else {
                dropdown.style.display = 'none';
                parent.classList.remove('open');
            }
        }
        
        function atualizarCountMineracao() {
            let count = 0;
            const mina = document.getElementById('mina_min')?.value;
            const boost = document.getElementById('status_aceleramento')?.value;
            const acoNegro = document.getElementById('status_aconegro')?.value;
            
            if (mina && parseFloat(mina) > 0) count++;
            if (boost && parseFloat(boost) > 0) count++;
            if (acoNegro && parseFloat(acoNegro) > 0) count++;
            
            const countEl = document.getElementById('count-mineracao');
            if (countEl) {
                countEl.textContent = count;
                countEl.classList.toggle('has-value', count > 0);
            }
        }
        
        function atualizarCountTreino() {
            let count = 0;
            const constituicao = document.getElementById('treino_constituicao')?.value;
            const musculo = document.getElementById('treino_muscular')?.value;
            const nineyin = document.getElementById('treino_noveyin')?.value;
            const nineyang = document.getElementById('treino_noveyang')?.value;
            const sapo = document.getElementById('treino_sapo')?.value;
            
            if (constituicao && parseFloat(constituicao) > 0) count++;
            if (musculo && parseFloat(musculo) > 0) count++;
            if (nineyin && parseFloat(nineyin) > 0) count++;
            if (nineyang && parseFloat(nineyang) > 0) count++;
            if (sapo && parseFloat(sapo) > 0) count++;
            
            const countEl = document.getElementById('count-treino');
            if (countEl) {
                countEl.textContent = count;
                countEl.classList.toggle('has-value', count > 0);
            }
        }
        
        function atualizarCountNivel() {
            let count = 0;
            const codex = document.getElementById('codex_min')?.value;
            const potencial = document.getElementById('potencial_min')?.value;
            const itens = document.getElementById('itens_comercio_min')?.value;
            
            if (codex && parseFloat(codex) > 0) count++;
            if (potencial && parseFloat(potencial) > 0) count++;
            if (itens && parseFloat(itens) > 0) count++;
            
            const countEl = document.getElementById('count-nivel');
            if (countEl) {
                countEl.textContent = count;
                countEl.classList.toggle('has-value', count > 0);
            }
        }
        
        function atualizarCountTrade() {
            let count = 0;
            const lend = document.getElementById('equip_lend_trade_min')?.value;
            const epic = document.getElementById('equip_epic_trade_min')?.value;
            
            if (lend && parseFloat(lend) > 0) count++;
            if (epic && parseFloat(epic) > 0) count++;
            
            const countEl = document.getElementById('count-trade');
            if (countEl) {
                countEl.textContent = count;
                countEl.classList.toggle('has-value', count > 0);
            }
        }
        
        // Filtrar por status (Listado / Com Lance)
        let filtroStatusAtual = 'listado';
        
        function filtrarPorStatus(status) {
            filtroStatusAtual = status;
            
            document.querySelectorAll('.tab-status').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${status}`).classList.add('active');
            
            // Rebuscar com o novo filtro
            buscarContas();
        }
        
        function mostrarAba(id) {
            document.querySelectorAll('.conteudo-aba').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.aba-filtro').forEach(el => el.classList.remove('active'));
            document.getElementById(`aba-${id}`).classList.add('active');
            
            const btns = document.querySelectorAll('.aba-filtro');
            for (let i = 0; i < btns.length; i++) {
                if (btns[i].textContent.trim().toLowerCase().includes(id.toLowerCase())) {
                    btns[i].classList.add('active');
                }
            }
        }

        function selecionarCache(tipo) {
            cacheTipo = tipo;
            document.querySelectorAll('.cache-type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`cache-${tipo}`).classList.add('active');
            document.getElementById('cache-info').innerText = `Modo: ${tipo === 'completas' ? 'Cache Completo' : 'Cache Teste'}`;
        }

        function mudarOrdenacao() {
            buscarContas();
        }

        function carregarCacheTeste() {
            if(!confirm("Carregar 10 contas de teste?")) return;
            
            // Mostrar status de carregamento
            document.getElementById('cache-info').innerHTML = "Status: <span style='color: #f6e05e'>游댃 Carregando 10 contas...</span>";
            
            // Desabilitar bot칫es durante o carregamento
            const botoesCache = document.querySelectorAll('.cache-type-btn, .btn-buscar');
            botoesCache.forEach(btn => btn.disabled = true);
            
            fetch('/carregar-teste', {method: 'POST'})
                .then(r => r.json())
                .then(d => { 
                    // Reabilitar bot칫es
                    botoesCache.forEach(btn => btn.disabled = false);
                    
                    if (d.success && d.contas_carregadas > 0) {
                        mostrarNotificacao(`Carregadas ${d.contas_carregadas} contas de teste`, 'success');
                        // Atualizar status e selecionar cache teste
                        verificarStatusCache(true); // true = for칞ar busca ap칩s carregar
                    } else {
                        mostrarNotificacao(d.message || 'Erro ao carregar cache teste', 'error');
                        verificarStatusCache(false);
                    }
                })
                .catch((error) => {
                    // Reabilitar bot칫es
                    botoesCache.forEach(btn => btn.disabled = false);
                    console.error('Erro:', error);
                    mostrarNotificacao("Erro de conex칚o ao carregar cache", 'error');
                    verificarStatusCache(false);
                });
        }

        function carregarCacheCompleto() {
            if (!confirm("Carregar TODAS as contas? Isso pode demorar v치rios minutos.")) return;
            
            // Mostrar status de carregamento
            document.getElementById('cache-info').innerHTML = "Status: <span style='color: #f6e05e'>游댃 Carregando todas as contas...</span>";
            
            // Desabilitar bot칫es durante o carregamento
            const botoesCache = document.querySelectorAll('.cache-type-btn, .btn-buscar');
            botoesCache.forEach(btn => btn.disabled = true);
            
            fetch('/carregar-completo', {method: 'POST'})
                .then(r => r.json())
                .then(d => { 
                    // Reabilitar bot칫es
                    botoesCache.forEach(btn => btn.disabled = false);
                    
                    if (d.success && d.contas_carregadas > 0) {
                        mostrarNotificacao(`Carregadas ${d.contas_carregadas} contas completas`, 'success');
                        // Atualizar status e selecionar cache completo
                        verificarStatusCache(true); // true = for칞ar busca ap칩s carregar
                    } else {
                        mostrarNotificacao(d.message || 'Erro ao carregar cache completo', 'error');
                        verificarStatusCache(false);
                    }
                })
                .catch((error) => {
                    // Reabilitar bot칫es
                    botoesCache.forEach(btn => btn.disabled = false);
                    console.error('Erro:', error);
                    mostrarNotificacao("Erro de conex칚o ao carregar cache completo", 'error');
                    verificarStatusCache(false);
                });
        }

        // Atualize a fun칞칚o verificarStatusCache
        function verificarStatusCache(buscarAposCarregar = false) {
            return fetch('/status-carregamento')
                .then(r => r.json())
                .then(data => {
                    const info = document.getElementById('cache-info');
                    
                    if (data.carregando) {
                        info.innerHTML = "Status: <span style='color: #f6e05e'>游댃 Carregando...</span>";
                        // Verificar novamente em 2 segundos se ainda estiver carregando
                        setTimeout(() => verificarStatusCache(buscarAposCarregar), 2000);
                    } else {
                        // Atualizar baseado no que est치 dispon칤vel
                        if (data.tem_cache_completo && data.total_completo > 0) {
                            info.innerHTML = `Status: <span style='color: #48bb78'>九 Cache Completo (${data.total_completo} contas)</span>`;
                            if (buscarAposCarregar) {
                                selecionarCache('completas');
                            }
                        } else if (data.tem_cache_teste && data.total_teste > 0) {
                            info.innerHTML = `Status: <span style='color: #ed8936'>丘멆잺 Cache Teste (${data.total_teste} contas)</span>`;
                            if (buscarAposCarregar) {
                                selecionarCache('teste');
                            }
                        } else {
                            info.innerHTML = "Status: <span style='color: #f56565'>仇 Sem Cache - Use os bot칫es acima</span>";
                        }
                    }
                    return data;
                })
                .catch(() => {
                    document.getElementById('cache-info').innerHTML = "Status: <span style='color: #f56565'>仇 Erro ao verificar</span>";
                });
        }
    </script>
</body>
</html>