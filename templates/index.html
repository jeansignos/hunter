<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIR4 Market Hunter - Pro</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3524/3524659.png">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>üèÜ MIR4 Market Hunter</h1>
        
        <div class="filtros-container">
            <aside class="menu-lateral">
                <div class="abas-filtros">
                    <button class="aba-filtro active" onclick="mostrarAba('geral')">Filtro</button>
                    <button class="aba-filtro" onclick="mostrarAba('combate')">Combate</button>
                </div>
                
                <div id="aba-geral" class="conteudo-aba active">
                    <div class="grupo-filtro">
                        <h3><i class="fas fa-users"></i> Classe</h3>
                        <div class="input-group">
                            <select id="classe" name="classe">
                                <option value="0">Todas as Classes</option>
                                {% for id, info in classes.items() %}
                                <option value="{{ id }}">{{ info.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="grupo-filtro">
                        <h3><i class="fas fa-bolt"></i> Poder & Level</h3>
                        <div class="campo-duplo">
                            <div class="input-group">
                                <label>Level M√≠n.</label>
                                <input type="number" id="level_min" placeholder="0">
                            </div>
                            <div class="input-group">
                                <label>Poder M√≠n.</label>
                                <input type="number" id="power_min" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <div class="grupo-filtro">
                        <h3><i class="fas fa-coins"></i> Pre√ßo WEMIX</h3>
                        <div class="campo-duplo">
                            <div class="input-group">
                                <label>M√≠nimo</label>
                                <input type="number" id="price_min" placeholder="0">
                            </div>
                            <div class="input-group">
                                <label>M√°ximo</label>
                                <input type="number" id="price_max" placeholder="10000">
                            </div>
                        </div>
                    </div>

                    <div class="grupo-filtro">
                        <h3><i class="fas fa-gem"></i> Minera√ß√£o (Obrigat√≥rio)</h3>
                        <div class="input-group">
                            <label>Mina (N√≠vel)</label>
                            <input type="number" id="mina_min" placeholder="Ex: 15">
                        </div>
                        
                        {% for status in status_importantes %}
                            {% if status.destaque and "Aceleramento de Minera√ß√£o" in status.nome %}
                            <div class="input-group">
                                <label style="color: #f6e05e;">Boost Minera√ß√£o (%)</label>
                                <input type="number" id="status_aceleramento" placeholder="Ex: 200">
                            </div>
                            {% endif %}
                        {% endfor %}

                        {% for status in status_importantes %}
                            {% if status.destaque and "Aumento de Ganho de A√ßo Negro" in status.nome %}
                            <div class="input-group">
                                <label style="color: #f6e05e;">Ganho A√ßo Negro (%)</label>
                                <input type="number" id="status_aconegro" placeholder="Ex: 150">
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
					<button class="btn-buscar" onclick="abrirModalStatus(event)" style="margin-bottom: 10px; background: #4a5568;">
                    <i class="fas fa-sliders-h"></i> Filtros de Status Avan√ßados
                </button>
					<button class="btn-buscar" onclick="buscarContas()">
                    <i class="fas fa-search"></i> Buscar Contas
                </button>
					
                </div>

                <div id="aba-combate" class="conteudo-aba">
                    <div class="grupo-filtro">
                        <h3><i class="fas fa-book"></i> Codex & Pets</h3>
                        <div class="campo-duplo">
                            <div class="input-group">
                                <label>Codex</label>
                                <input type="number" id="codex_min" placeholder="0">
                            </div>
                            <div class="input-group">
                                <label>Pets Lend.</label>
                                <input type="number" id="pets_lendarios_min" placeholder="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="grupo-filtro">
   <div class="grupo-filtro">
    <h3><i class="fas fa-database"></i> Cache</h3>
    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
        <button class="btn-buscar" style="background: #333; font-size: 0.8rem; padding: 8px;" onclick="carregarCacheTeste()">Carregar 10</button>
        <button class="btn-buscar" style="background: #333; font-size: 0.8rem; padding: 8px;" onclick="carregarCacheCompleto()">Carregar Todas</button>
    </div>
    
    <!-- Bot√µes de sele√ß√£o de cache - AGORA Sempre Full primeiro quando dispon√≠vel -->
    <div class="cache-type-selector">
        <button type="button" 
                class="cache-type-btn 
                    {% if tem_cache_completo and cache_padrao == 'completas' %}active{% endif %}
                    {% if not tem_cache_completo %}disabled{% endif %}" 
                onclick="selecionarCache('completas')" 
                id="cache-completas"
                {% if not tem_cache_completo %}disabled title="Cache completo n√£o dispon√≠vel"{% endif %}>
            Usar Full {% if cache_padrao == 'completas' %}(Padr√£o){% endif %}
        </button>
        <button type="button" 
                class="cache-type-btn 
                    {% if not tem_cache_completo and tem_cache_teste and cache_padrao == 'teste' %}active{% endif %}
                    {% if not tem_cache_teste %}disabled{% endif %}" 
                onclick="selecionarCache('teste')" 
                id="cache-teste"
                {% if not tem_cache_teste %}disabled title="Cache teste n√£o dispon√≠vel"{% endif %}>
            Usar Teste {% if not tem_cache_completo and cache_padrao == 'teste' %}(Padr√£o){% endif %}
        </button>
    </div>
    
    <!-- Informa√ß√µes do cache -->
    <div id="cache-info" style="margin-top: 10px;">
        {% if cache_status == 'completo' %}
        <span style="color: #48bb78; font-size: 0.8rem;">
            ‚úÖ Cache Full ({{ total_completo }} contas) - Selecionado por padr√£o
        </span>
        {% elif cache_status == 'teste' %}
        <span style="color: #ed8936; font-size: 0.8rem;">
            ‚ö†Ô∏è Cache Teste ({{ total_teste }} contas) - Full n√£o dispon√≠vel
        </span>
        {% else %}
        <span style="color: #f56565; font-size: 0.8rem;">
            ‚ùå Sem cache - Carregue dados primeiro
        </span>
        {% endif %}
    </div>
</div>

                <button class="btn-buscar" onclick="abrirModalStatus(event)" style="margin-bottom: 10px; background: #4a5568;">
                    <i class="fas fa-sliders-h"></i> Filtros de Status Avan√ßados
                </button>

                <button class="btn-buscar" onclick="buscarContas()">
                    <i class="fas fa-search"></i> Buscar Contas
                </button>
            </aside>

            <main>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center;">
                    <h2 style="font-size: 1.2rem; color: #fff;">Resultados Dispon√≠veis</h2>
                    <div class="input-group" style="width: 200px; margin-bottom: 0;">
                        <select id="ordenacao" onchange="mudarOrdenacao()">
                            <option value="power">Maior Poder</option>
                            <option value="level">Maior Level</option>
                            <option value="price">Menor Pre√ßo</option>
                            <option value="price_desc">Maior Pre√ßo</option>
                            <option value="aceleramento">Melhor Minera√ß√£o</option>
                            <option value="aconegro">Mais A√ßo Negro</option>
                            <option value="codex">Maior Codex</option>
                            <option value="mina">Maior N√≠vel Mina</option>
                            <option value="constituicao">Maior Constitui√ß√£o</option>
                        </select>
                    </div>
                </div>

                <div id="resultados" class="contas-grid">
                    <div class="sem-resultados">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                        <p>Configure os filtros e clique em Buscar</p>
                    </div>
                </div>
                
                <div class="paginacao-container" id="paginacao-container" style="display: none;">
                    <button class="btn-buscar" style="width: auto; padding: 10px 30px;" onclick="carregarMaisContas()">
                        Carregar Mais
                    </button>
                    <span id="info-paginacao" style="display: block; margin-top: 10px; color: #888;"></span>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Status Avan√ßados -->
    <div id="modal-status" class="modal" onclick="fecharModalStatus()">
        <div class="modal-conteudo" onclick="event.stopPropagation()">
            <div class="modal-cabecalho">
                <h2><i class="fas fa-sliders-h"></i> Filtros de Status Avan√ßados</h2>
                <span class="fechar-modal" onclick="fecharModalStatus()">&times;</span>
            </div>
            <div class="modal-corpo">
                <p style="font-size: 0.9rem; color: #a0aec0; margin-bottom: 15px;">
                    Defina valores m√≠nimos para os status abaixo. Deixe em branco para ignorar.
                </p>
                
                <div class="modal-buscar">
                    <input type="text" id="busca-status" placeholder="Buscar status..." onkeyup="filtrarStatus()" 
                           style="width: 100%; padding: 10px; background: #2d3748; border: 1px solid #4a5568; color: white; border-radius: 5px;">
                </div>
                
                <div id="lista-status" style="max-height: 50vh; overflow-y: auto; padding-right: 10px; margin-top: 15px;">
                    {% for status in status_importantes %}
                        {% if not status.destaque %}
                        <div class="status-item" data-nome="{{ status.nome|lower }}" 
                             style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #4a5568;">
                            <div class="status-info">
                                <label style="font-size: 0.85rem; color: white;">{{ status.nome }}</label>
                            </div>
                            <div class="status-input">
                                <input type="number" id="status_{{ status.hash }}" 
                                       placeholder="0" 
                                       style="width: 100px; font-size: 0.9rem; padding: 6px 10px; background: #2d3748; border: 1px solid #4a5568; color: white; border-radius: 5px;"
                                       value="">
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <div class="modal-controles" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-modal btn-limpar" onclick="limparFiltrosStatus()" 
                            style="flex: 1; padding: 10px; background: #718096; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-trash-alt"></i> Limpar Todos
                    </button>
                    <button class="btn-modal btn-aplicar" onclick="fecharModalStatus()" 
                            style="flex: 1; padding: 10px; background: #4299e1; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-check"></i> Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Todos os Status -->
    <div id="modal-todos-status" class="modal" onclick="fecharModalTodosStatus()">
        <div class="modal-conteudo" onclick="event.stopPropagation()">
            <div class="modal-cabecalho">
                <h2><i class="fas fa-chart-bar"></i> Todos os Status</h2>
                <span class="fechar-modal" onclick="fecharModalTodosStatus()">&times;</span>
            </div>
            <div class="modal-corpo">
                <div class="modal-buscar">
                    <input type="text" id="buscar-status-modal" placeholder="Buscar status..."
                           style="width: 100%; padding: 10px; background: #2d3748; border: 1px solid #4a5568; color: white; border-radius: 5px;">
                </div>
                <div id="status-container" class="status-grid" style="margin-top: 15px;">
                    <!-- Status ser√£o carregados aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ïES GLOBAIS ---
        const ICONS_PATH = "{{ url_for('static', filename='icons/') }}";
        let cacheTipo = 'completas'; // Come√ßa com teste
        let paginaAtual = 0;
        let todasContas = [];
        let filtrosAtuais = null;
        const LIMITE_POR_PAGINA = 10;
        let totalContasFiltradas = 0;

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', function() {
            verificarStatusCache();
            
            // Seleciona cache teste por padr√£o
            selecionarCache('completas');
        });

        // --- FUN√á√ïES DO MODAL ---
        function abrirModalStatus(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const modal = document.getElementById('modal-status');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
            
            // Focar no campo de busca
            setTimeout(() => {
                document.getElementById('busca-status')?.focus();
            }, 50);
        }

        function fecharModalStatus() {
            const modal = document.getElementById('modal-status');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function filtrarStatus() {
            const busca = document.getElementById('busca-status')?.value.toLowerCase() || '';
            const items = document.querySelectorAll('#lista-status .status-item');
            
            items.forEach(item => {
                const nome = item.getAttribute('data-nome');
                if (nome.includes(busca)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function limparFiltrosStatus() {
            if (confirm('Limpar todos os filtros de status?')) {
                document.querySelectorAll('#lista-status input').forEach(input => {
                    input.value = '';
                });
                
                const aceleramento = document.getElementById('status_aceleramento');
                const aconegro = document.getElementById('status_aconegro');
                const minaMin = document.getElementById('mina_min');
                
                if (aceleramento) aceleramento.value = '';
                if (aconegro) aconegro.value = '';
                if (minaMin) minaMin.value = '';
            }
        }

        // --- FUN√á√ïES DO MODAL DE TODOS OS STATUS ---
        function abrirModalTodosStatus(event) {
            event.stopPropagation();
            
            try {
                const statsStr = event.currentTarget.getAttribute('data-stats');
                if (!statsStr) return;
                
                const stats = JSON.parse(statsStr);
                preencherModalStatus(stats);
                
                const modal = document.getElementById('modal-todos-status');
                modal.style.display = 'block';
                setTimeout(() => {
                    modal.style.opacity = '1';
                }, 10);
                
                setTimeout(() => {
                    document.getElementById('buscar-status-modal')?.focus();
                }, 50);
                
            } catch (error) {
                console.error('Erro ao abrir modal de status:', error);
                mostrarNotificacao('Erro ao carregar status', 'error');
            }
        }

        function fecharModalTodosStatus() {
            const modal = document.getElementById('modal-todos-status');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('buscar-status-modal').value = '';
            }, 300);
        }

        function preencherModalStatus(stats) {
            const container = document.getElementById('status-container');
            container.innerHTML = '';
            
            if (!stats || stats.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #a0aec0;">
                        <i class="fas fa-info-circle"></i>
                        <p>Nenhum status dispon√≠vel para esta conta.</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar por nome
            const statsOrdenados = [...stats].sort((a, b) => 
                a.statName?.localeCompare(b.statName || '') || 0
            );
            
            statsOrdenados.forEach(stat => {
                const div = document.createElement('div');
                div.className = 'status-item-modal';
                div.style.cssText = 'display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #4a5568;';
                
                const valorFormatado = formatarValorStatus(stat.statValue || '0');
                
                div.innerHTML = `
                    <div class="status-icon-modal" style="margin-right: 15px;">
                        ${stat.iconPath ? 
                            `<img src="${stat.iconPath}" alt="${stat.statName}" style="width: 32px; height: 32px;">` : 
                            `<i class="fas fa-chart-line" style="font-size: 24px; color: #4299e1;"></i>`
                        }
                    </div>
                    <div class="status-info-modal" style="flex: 1;">
                        <div class="status-name-modal" title="${stat.statName || ''}" style="color: white; font-size: 0.9rem;">
                            ${stat.statName || 'Status'}
                        </div>
                        <div class="status-value-modal" style="color: #f6e05e; font-weight: bold; font-size: 1rem;">
                            ${valorFormatado}
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function formatarValorStatus(valor) {
            if (!valor || valor === 'null' || valor === 'undefined' || valor === '') {
                return '0';
            }
            
            if (valor.toString().includes('%')) {
                return valor.toString();
            }
            
            let numero = valor.toString().replace(/,/g, '');
            if (numero.includes(',') && !numero.includes('.')) {
                numero = numero.replace(',', '.');
            }
            
            const num = parseFloat(numero);
            if (isNaN(num)) {
                return valor.toString();
            }
            
            if (num % 1 === 0) {
                return Math.round(num).toLocaleString('pt-BR');
            }
            
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(2) + 'B';
            } else if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            
            return num.toFixed(2);
        }

        function mostrarNotificacao(mensagem, tipo = 'info') {
            const notifAnterior = document.querySelector('.notification');
            if (notifAnterior) {
                notifAnterior.remove();
            }
            
            const notificacao = document.createElement('div');
            notificacao.className = `notification ${tipo}`;
            
            let icone = 'info-circle';
            if (tipo === 'success') icone = 'check-circle';
            if (tipo === 'error') icone = 'exclamation-circle';
            if (tipo === 'warning') icone = 'exclamation-triangle';
            
            notificacao.innerHTML = `
                <i class="fas fa-${icone}"></i>
                <span>${mensagem}</span>
            `;
            
            document.body.appendChild(notificacao);
            
            setTimeout(() => {
                notificacao.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notificacao.classList.remove('show');
                setTimeout(() => {
                    if (notificacao.parentNode) {
                        notificacao.remove();
                    }
                }, 300);
            }, 4000);
        }

        // --- FUN√á√ïES DE FORMATA√á√ÉO ---
        function formatarNumero(num) {
            if (num === undefined || num === null) return "0";
            if (typeof num === 'string') {
                num = parseFloat(num.replace(/,/g, ''));
            }
            if (isNaN(num)) return "0";
            
            if (num >= 1000) {
                return num.toLocaleString('pt-BR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }
            
            if (num % 1 !== 0) {
                return num.toFixed(1).replace('.', ',');
            }
            
            return num.toString();
        }

        function formatarPorcentagem(num) {
            if (num === undefined || num === null) return "0%";
            if (typeof num === 'string') {
                num = parseFloat(num.replace(/,/g, ''));
            }
            if (isNaN(num)) return "0%";
            return num.toFixed(1) + "%";
        }

        // --- FUN√á√ÉO AUXILIAR PARA RENDERIZAR ITENS ---
        // --- FUN√á√ÉO AUXILIAR PARA RENDERIZAR ITENS (ATUALIZADA) ---
function renderItemIcon(item) {
    if (!item) {
        return '<div class="item-circle" style="border-style: dashed; border-color: #444; background: rgba(0,0,0,0.3);"><i class="fas fa-question"></i></div>';
    }
    
    const gradeClass = `grade-${item.grade || 1}`;
    const enhanceHtml = item.enhance > 0 ? `<div class="badge-enhance">+${item.enhance}</div>` : '';
    
    // Tier em Romano
    const tiers = ["", "I", "II", "III", "IV", "V"];
    const tierHtml = item.tier > 0 ? `<div class="badge-tier">${tiers[item.tier] || 'I'}</div>` : '';
    
    // Trade - Agora usando imagem personalizada
    const tradeHtml = item.trade ? `<div class="badge-trade" title="Item Negoci√°vel"></div>` : '';
    
    // Quantidade
    const countHtml = item.count > 1 ? `<div class="badge-count">${item.count}</div>` : '';

    // Se n√£o tiver imagem, usar √≠cone com fundo da raridade
    if (!item.img || item.img === '') {
        return `
        <div class="item-circle ${gradeClass} no-img" title="${item.name || ''}">
            <i class="fas fa-box" style="color: rgba(255,255,255,0.8);"></i>
            ${enhanceHtml}
            ${tierHtml}
            ${tradeHtml}
            ${countHtml}
        </div>
        `;
    }
	

    // Com imagem - background da imagem com overlay da raridade
    return `
    <div class="item-circle ${gradeClass}" 
         style="background-image: url('${item.img}');" 
         title="${item.name || ''}">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: inherit; border-radius: 10px;"></div>
        ${enhanceHtml}
        ${tierHtml}
        ${tradeHtml}
        ${countHtml}
    </div>
    `;
}

        // --- CONSTRUTOR DO CARD ---
        function criarCardConta(conta) {
            const cardType = conta.powerScore > 250000 ? 'type-gold' : 'type-blue';
            
            // Imagem da classe
            const imgClass = conta.class.imagem ? 
                `<img src="${ICONS_PATH}${conta.class.imagem}" alt="${conta.class.nome}" style="width: 60px; height: 60px;">` : 
                `<span style="font-size: 40px;">${conta.class.icone}</span>`;

            // Formata√ß√£o
            const phyAtk = formatarNumero(conta.ataque_fisico || 0);
            const magAtk = formatarNumero(conta.ataque_magico || 0);
            const crit = formatarNumero(conta.critico || 0);
            const miningBoost = formatarPorcentagem(conta.aceleramento_mineracao || 0);
            const darksteelBoost = formatarPorcentagem(conta.aumento_aconegro || 0);
            const priceUsd = conta.price_brl ? `(R$ ${conta.price_brl.toLocaleString('pt-BR')})` : '($ --)';

            // Preparar dados
            const equips = Array.isArray(conta.equip) ? conta.equip : [];
            const spirits = Array.isArray(conta.spirit_list) ? conta.spirit_list : [];
            const skills = Array.isArray(conta.skills_list) ? conta.skills_list : [];
            const inventory = Array.isArray(conta.inven) ? conta.inven : [];
            const training = conta.training_details || { constituicao: 0, inner_force: [] };

            // Aba 0: Info Geral
            const tab0Content = `
                <div class="card-avatar-section">
                    <div class="class-name-vertical">${conta.class.nome}</div>
                    <div class="diamond-shape">
                        ${imgClass}
                    </div>
                </div>

                <div class="card-main-info">
                    <div class="card-level">LV. ${conta.level}</div>
                    <div class="card-power">${formatarNumero(conta.powerScore)}</div>
                    <div class="card-player-name">${conta.name}</div>
                </div>

                <div class="card-stats-grid">
                    <div class="stat-box">
                        <label>Atk F√≠sico</label>
                        <span>${phyAtk}</span>
                    </div>
                    <div class="stat-box">
                        <label>Atk M√°gico</label>
                        <span>${magAtk}</span>
                    </div>
                    <div class="stat-box">
                        <label>Cr√≠tico</label>
                        <span>${crit}</span>
                    </div>

                    <div class="stat-box mining-highlight">
                        <label>Minera√ß√£o</label>
                        <span>${miningBoost}</span>
                    </div>
                    <div class="stat-box mining-highlight">
                        <label>A√ßo Negro</label>
                        <span>${darksteelBoost}</span>
                    </div>
                    <div class="stat-box">
                        <label>Mina</label>
                        <span>${conta.mina || 0}</span>
                    </div>

                    <div class="stat-box">
                        <label>[L] Pets</label>
                        <span>${conta.pets?.lendarios || 0}</span>
                    </div>
                    <div class="stat-box">
                        <label>[L] Skills</label>
                        <span>${conta.skills?.lendarias || 0}</span>
                    </div>
                    <div class="stat-box">
                        <label>Codex</label>
                        <span>${conta.codex || 0}</span>
                    </div>
                </div>
				
            `;

            // Aba 1: Equip, Esp√≠ritos, Skills
            const equipsHtml = equips.length ? 
                equips.map(item => renderItemIcon(item)).join('') : 
                '<p style="grid-column:1/-1; text-align:center; font-size:0.8rem; color:#718096;">Sem equipamentos</p>';
                
            const spiritsHtml = spirits.length ? 
                spirits.map(item => renderItemIcon(item)).join('') : 
                '<p style="grid-column:1/-1; text-align:center; font-size:0.8rem; color:#718096;">Sem esp√≠ritos</p>';
                
            const skillsHtml = skills.length ? 
                skills.map(item => renderItemIcon(item)).join('') : 
                '<p style="grid-column:1/-1; text-align:center; font-size:0.8rem; color:#718096;">Sem habilidades</p>';

            const tab1Content = `
                <div class="section-title">Equipamentos</div>
                <div class="items-grid">${equipsHtml}</div>
                
                <div class="section-title">Esp√≠ritos</div>
                <div class="items-grid">${spiritsHtml}</div>

                <div class="section-title">Habilidades</div>
                <div class="items-grid no-tier">${skillsHtml}</div>
            `;

            // Aba 2: Treino
            let forceHtml = '';
            if (training.inner_force && training.inner_force.length > 0) {
                forceHtml = training.inner_force.map(f => `
                    <div class="stat-box">
                        <label>${f.name || 'For√ßa'}</label>
                        <span style="color: ${f.level >= 10 ? '#f6e05e' : '#fff'}">${f.level || 0}</span>
                    </div>
                `).join('');
            } else {
                forceHtml = '<p style="grid-column:1/-1; text-align:center; font-size:0.8rem; color:#718096;">Sem dados de for√ßa interna</p>';
            }

            const tab2Content = `
                <div style="margin-top: 20px;">
                    <div class="training-box">
                        <div class="training-lbl">CONSTITUI√á√ÉO</div>
                        <div class="training-val">${training.constituicao || conta.constituicao || 0}</div>
                    </div>
                    
                    <div class="section-title">For√ßa Interna</div>
                    <div class="card-stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                        ${forceHtml}
                    </div>
                     
                    <div class="section-title">Potencial</div>
                     <div class="training-box" style="padding: 5px;">
                        <div class="training-val" style="font-size: 1rem;">${conta.potencial || 0}</div>
                    </div>
                </div>
            `;

            // Aba 3: Invent√°rio
            // Aba 3: Invent√°rio - SOMENTE itens negoci√°veis (com trade: true)
const itensNegociaveis = inventory.filter(item => {
    // Filtra apenas itens com trade: true
    return item.trade === true;
});

const invenHtml = itensNegociaveis.length ? 
    itensNegociaveis.map(item => renderItemIcon(item)).join('') : 
    '<div style="text-align:center; padding:20px; color:#718096; font-size:0.9rem;">Sem itens negoci√°veis</div>';

const tab3Content = `
    <div class="section-title">Itens Negoci√°veis (${itensNegociaveis.length} itens)</div>
    <div class="items-grid" style="max-height: 300px; overflow-y: auto;">
        ${invenHtml}
    </div>
`;

            // Estrutura do Card
            return `
            <div class="nft-card ${cardType}" id="card-${conta.seq}">
                <div class="card-top-bar">
                    <span class="card-status-badge">LISTADO</span>
                    <span class="card-price-top">${conta.price.toLocaleString()} WEMIX</span>
                </div>

                <div class="card-tabs">
                    <button class="card-tab-btn active" onclick="switchCardTab(this, ${conta.seq}, 0)"><i class="fas fa-home"></i></button>
                    <button class="card-tab-btn" onclick="switchCardTab(this, ${conta.seq}, 1)"><i class="fas fa-tshirt"></i></button>
                    <button class="card-tab-btn" onclick="switchCardTab(this, ${conta.seq}, 2)"><i class="fas fa-dumbbell"></i></button>
                    <button class="card-tab-btn" onclick="switchCardTab(this, ${conta.seq}, 3)"><i class="fas fa-box-open"></i></button>
                </div>

                <div class="tab-content active" data-tab="0">
                    ${tab0Content}
                </div>
                
                <div class="tab-content" data-tab="1">
                    ${tab1Content}
                </div>
                
                <div class="tab-content" data-tab="2">
                    ${tab2Content}
                </div>

                <div class="tab-content" data-tab="3">
                    ${tab3Content}
                </div>

                <a href="${conta.url}" target="_blank" class="card-action-btn" style="margin-top: auto;">
                    <div class="wemix-display">
                        <i class="fas fa-external-link-alt"></i>
                        ${conta.price.toLocaleString()} WEMIX
                    </div>
                    <div class="usd-display">${priceUsd}</div>
                </a>
                
                <button class="btn-todos-status" onclick="abrirModalTodosStatus(event)" 
                        data-stats='${JSON.stringify(conta.stats).replace(/'/g, "&apos;")}'>
                    <i class="fas fa-list"></i> Todos os Status
                </button>

                <div class="card-footer-info">
                    <span>${conta.worldName}</span>
                    <span>#${conta.seq}</span>
                </div>
            </div>
            `;
        }

        // --- FUN√á√ïES DE INTERA√á√ÉO ---
        function switchCardTab(btn, cardSeq, tabIndex) {
    const card = document.getElementById(`card-${cardSeq}`);
    if (!card) return;

    // Remove active de todos os bot√µes e abas
    card.querySelectorAll('.card-tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    card.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    // Se for aba 2 ou 3 e ainda n√£o foi carregada, mostrar loading
    const targetTab = card.querySelector(`.tab-content[data-tab="${tabIndex}"]`);
    if (targetTab) {
        targetTab.classList.add('active');
        
        // Verificar se a aba j√° foi carregada
        if ((tabIndex === 2 || tabIndex === 3) && !targetTab.dataset.loaded) {
            // Mostrar loading
            const originalHTML = targetTab.innerHTML;
            targetTab.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p style="margin-top: 10px;">Carregando...</p>
                </div>
            `;
            
            // Simular carregamento (na pr√°tica, os dados j√° est√£o carregados)
            setTimeout(() => {
                targetTab.innerHTML = originalHTML;
                targetTab.dataset.loaded = 'true';
            }, 100);
        }
    }
}

        // --- BUSCA E FILTROS ---
     function buscarContas() {
    const resultados = document.getElementById('resultados');
    resultados.innerHTML = '<div class="loading"><i class="fas fa-circle-notch fa-spin fa-2x"></i><p>Carregando dados...</p></div>';
    
    paginaAtual = 0;
    todasContas = [];
    
    const params = new URLSearchParams();
    params.append('cache_tipo', cacheTipo);
    params.append('pagina', paginaAtual);
    params.append('limite', LIMITE_POR_PAGINA);
    
    // Coleta filtros b√°sicos
    const ids = [
        'classe', 'power_min', 'power_max', 'level_min', 'level_max', 
        'price_min', 'price_max', 'mina_min', 'codex_min', 
        'pets_lendarios_min', 'pets_misticos_min', 'habs_lendarias_min',
        'constituicao_min'
    ];
    
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.value) params.append(id, el.value);
    });

    // Status de minera√ß√£o - IMPORTANTE: usar os IDs corretos
    const aceleramento = document.getElementById('status_aceleramento');
    const aconegro = document.getElementById('status_aconegro');
    
    // Use o hash do status para os par√¢metros
    {% for status in status_importantes %}
        {% if status.destaque and "Aceleramento de Minera√ß√£o" in status.nome %}
            if (aceleramento && aceleramento.value) {
                params.append('status_{{ status.hash }}', aceleramento.value);
            }
        {% endif %}
        {% if status.destaque and "Aumento de Ganho de A√ßo Negro" in status.nome %}
            if (aconegro && aconegro.value) {
                params.append('status_{{ status.hash }}', aconegro.value);
            }
        {% endif %}
    {% endfor %}

    // Status din√¢micos do modal
    document.querySelectorAll('#lista-status input').forEach(input => {
        if (input.value) params.append(input.id, input.value);
    });

    // Ordena√ß√£o
    const ordenacao = document.getElementById('ordenacao').value;
    if (ordenacao.includes('price')) {
        params.append('ordenar_por', 'price');
        params.append('ordenar_desc', ordenacao === 'price_desc');
    } else if (ordenacao === 'aceleramento' || ordenacao === 'aconegro') {
        params.append('ordenar_por', ordenacao);
        params.append('ordenar_desc', 'true');
    } else {
        params.append('ordenar_por', ordenacao);
        params.append('ordenar_desc', 'true');
    }

    filtrosAtuais = params;

    fetch(`/buscar-contas?${params.toString()}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                todasContas = data.contas || [];
                totalContasFiltradas = data.total_filtrado || 0;
                renderizarResultados(todasContas);
                
                // Mostrar notifica√ß√£o com status aplicados
                const statusFiltros = Array.from(params.entries())
                    .filter(([key]) => key.startsWith('status_'))
                    .map(([key, value]) => `${key.replace('status_', '')}: ${value}`);
                
                if (statusFiltros.length > 0) {
                    mostrarNotificacao(`${statusFiltros.length} filtro(s) de status aplicado(s)`, 'success');
                }
            } else {
                resultados.innerHTML = `<div class="sem-resultados"><p>${data.error}</p></div>`;
            }
        })
        .catch(e => {
            console.error("Erro na busca:", e);
            resultados.innerHTML = '<div class="sem-resultados"><p>Erro de conex√£o</p></div>';
        });
}

        function carregarMaisContas() {
            paginaAtual++;
            const btn = document.querySelector('.paginacao-container button');
            if (!btn) return;
            
            const originalText = btn.innerText;
            btn.innerText = "Carregando...";
            btn.disabled = true;

            filtrosAtuais.set('pagina', paginaAtual);

            fetch(`/buscar-contas?${filtrosAtuais.toString()}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.contas && data.contas.length > 0) {
                        todasContas = [...todasContas, ...data.contas];
                        renderizarResultados(todasContas);
                    }
                    btn.innerText = originalText;
                    btn.disabled = false;
                })
                .catch(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }

        function renderizarResultados(contas) {
            const resultados = document.getElementById('resultados');
            const pagContainer = document.getElementById('paginacao-container');
            const infoPag = document.getElementById('info-paginacao');

            if (contas.length === 0) {
                resultados.innerHTML = `
                    <div class="sem-resultados">
                        <i class="fas fa-ghost fa-2x"></i>
                        <h3>Nenhuma conta encontrada</h3>
                        <p>Tente diminuir os filtros.</p>
                    </div>`;
                pagContainer.style.display = 'none';
                return;
            }

            resultados.innerHTML = contas.map(conta => criarCardConta(conta)).join('');
            
            if (contas.length < totalContasFiltradas) {
                pagContainer.style.display = 'flex';
                pagContainer.style.flexDirection = 'column';
                pagContainer.style.alignItems = 'center';
                infoPag.textContent = `Mostrando ${contas.length} de ${totalContasFiltradas}`;
            } else {
                pagContainer.style.display = 'none';
            }
        }

        // --- UI FUNCTIONS ---
        function mostrarAba(id) {
            document.querySelectorAll('.conteudo-aba').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.aba-filtro').forEach(el => el.classList.remove('active'));
            document.getElementById(`aba-${id}`).classList.add('active');
            
            const btns = document.querySelectorAll('.aba-filtro');
            for (let i = 0; i < btns.length; i++) {
                if (btns[i].textContent.trim().toLowerCase().includes(id.toLowerCase())) {
                    btns[i].classList.add('active');
                }
            }
        }

        function selecionarCache(tipo) {
            cacheTipo = tipo;
            document.querySelectorAll('.cache-type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`cache-${tipo}`).classList.add('active');
            document.getElementById('cache-info').innerText = `Modo: ${tipo === 'completas' ? 'Cache Completo' : 'Cache Teste'}`;
        }

        function mudarOrdenacao() {
            buscarContas();
        }

        function carregarCacheTeste() {
    if(!confirm("Carregar 10 contas de teste?")) return;
    
    // Mostrar status de carregamento
    document.getElementById('cache-info').innerHTML = "Status: <span style='color: #f6e05e'>üîÑ Carregando 10 contas...</span>";
    
    // Desabilitar bot√µes durante o carregamento
    const botoesCache = document.querySelectorAll('.cache-type-btn, .btn-buscar');
    botoesCache.forEach(btn => btn.disabled = true);
    
    fetch('/carregar-teste', {method: 'POST'})
        .then(r => r.json())
        .then(d => { 
            // Reabilitar bot√µes
            botoesCache.forEach(btn => btn.disabled = false);
            
            if (d.success && d.contas_carregadas > 0) {
                mostrarNotificacao(`Carregadas ${d.contas_carregadas} contas de teste`, 'success');
                // Atualizar status e selecionar cache teste
                verificarStatusCache(true); // true = for√ßar busca ap√≥s carregar
            } else {
                mostrarNotificacao(d.message || 'Erro ao carregar cache teste', 'error');
                verificarStatusCache(false);
            }
        })
        .catch((error) => {
            // Reabilitar bot√µes
            botoesCache.forEach(btn => btn.disabled = false);
            console.error('Erro:', error);
            mostrarNotificacao("Erro de conex√£o ao carregar cache", 'error');
            verificarStatusCache(false);
        });
}

function carregarCacheCompleto() {
    if (!confirm("Carregar TODAS as contas? Isso pode demorar v√°rios minutos.")) return;
    
    // Mostrar status de carregamento
    document.getElementById('cache-info').innerHTML = "Status: <span style='color: #f6e05e'>üîÑ Carregando todas as contas...</span>";
    
    // Desabilitar bot√µes durante o carregamento
    const botoesCache = document.querySelectorAll('.cache-type-btn, .btn-buscar');
    botoesCache.forEach(btn => btn.disabled = true);
    
    fetch('/carregar-completo', {method: 'POST'})
        .then(r => r.json())
        .then(d => { 
            // Reabilitar bot√µes
            botoesCache.forEach(btn => btn.disabled = false);
            
            if (d.success && d.contas_carregadas > 0) {
                mostrarNotificacao(`Carregadas ${d.contas_carregadas} contas completas`, 'success');
                // Atualizar status e selecionar cache completo
                verificarStatusCache(true); // true = for√ßar busca ap√≥s carregar
            } else {
                mostrarNotificacao(d.message || 'Erro ao carregar cache completo', 'error');
                verificarStatusCache(false);
            }
        })
        .catch((error) => {
            // Reabilitar bot√µes
            botoesCache.forEach(btn => btn.disabled = false);
            console.error('Erro:', error);
            mostrarNotificacao("Erro de conex√£o ao carregar cache completo", 'error');
            verificarStatusCache(false);
        });
}

// Atualize a fun√ß√£o verificarStatusCache
function verificarStatusCache(buscarAposCarregar = false) {
    return fetch('/status-carregamento')
        .then(r => r.json())
        .then(data => {
            const info = document.getElementById('cache-info');
            
            if (data.carregando) {
                info.innerHTML = "Status: <span style='color: #f6e05e'>üîÑ Carregando...</span>";
                // Verificar novamente em 2 segundos se ainda estiver carregando
                setTimeout(() => verificarStatusCache(buscarAposCarregar), 2000);
            } else {
                // Atualizar baseado no que est√° dispon√≠vel
                if (data.tem_cache_completo && data.total_completo > 0) {
                    info.innerHTML = `Status: <span style='color: #48bb78'>‚úÖ Cache Completo (${data.total_completo} contas)</span>`;
                    if (buscarAposCarregar) {
                        selecionarCache('completas');
                    }
                } else if (data.tem_cache_teste && data.total_teste > 0) {
                    info.innerHTML = `Status: <span style='color: #ed8936'>‚ö†Ô∏è Cache Teste (${data.total_teste} contas)</span>`;
                    if (buscarAposCarregar) {
                        selecionarCache('teste');
                    }
                } else {
                    info.innerHTML = "Status: <span style='color: #f56565'>‚ùå Sem Cache - Use os bot√µes acima</span>";
                }
            }
            return data;
        })
        .catch(() => {
            document.getElementById('cache-info').innerHTML = "Status: <span style='color: #f56565'>‚ùå Erro ao verificar</span>";
        });
}

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            verificarStatusCache();
        });
    </script>
</body>
</html>